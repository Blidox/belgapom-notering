<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Belgapom â€“ Notering</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-[#f0ebd8] text-[#0d1321]">

  <!-- Header -->
  <header class="p-4 flex justify-between items-center bg-white shadow">
    <div>
      <h1 class="text-xl font-bold">Belgapom â€“ Notering</h1>
      <p class="text-sm">Contractprijzen en wekelijkse notering (vrije aardappelen)</p>
    </div>
    <div class="flex gap-2">
      <button id="btn-nl" class="px-3 py-1 border rounded">NL</button>
      <button id="btn-fr" class="px-3 py-1 border rounded">FR</button>
      <button id="btn-print" class="px-3 py-1 border rounded">PDF</button>
    </div>
  </header>

  <!-- Main -->
  <main class="p-6 flex flex-col gap-4">

    <div class="bg-white p-6 rounded-2xl shadow">
      <h2 class="font-semibold text-lg mb-2 flex items-center gap-2">
        <span>ðŸ“Š Historiek</span>
      </h2>

      <!-- KPI grid -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-center">
        <div>
          <p class="text-sm">Notering</p>
          <p id="kpi-quote" class="text-xl font-bold">â€“</p>
          <p id="kpi-sentiment" class="inline-block mt-1 px-2 py-1 rounded-full text-xs bg-slate-600 text-white">â€“</p>
        </div>
        <div>
          <p class="text-sm">Contractprijs</p>
          <p id="kpi-contract" class="text-xl font-bold">â€“</p>
        </div>
        <div>
          <p class="text-sm">Week</p>
          <p id="kpi-week" class="text-xl font-bold">â€“</p>
        </div>
        <div>
          <p class="text-sm">Datum</p>
          <p id="kpi-date" class="text-xl font-bold">â€“</p>
        </div>
      </div>

      <!-- Chart -->
      <div class="h-96">
        <canvas id="chart"></canvas>
      </div>

      <p class="mt-2 text-sm text-slate-600" id="seasonLabel"></p>
    </div>

    <!-- Footer box -->
    <div class="bg-white p-4 rounded-2xl shadow text-sm text-slate-600">
      <p>Laatste update: <span id="lastUpdate">â€“</span></p>
      <p>Bron: interne rapportering</p>
      <p class="mt-2">Â© <span id="year"></span> Belgapom</p>
    </div>
  </main>

  <!-- Script -->
  <script>
  const APP_SCRIPT_JSON_URL =
    "https://script.google.com/macros/s/AKfycbxXkCIga_MkeIkNPYtssLI9rA_sCBMUxRYYNH13ZXxj3MSkvObWk8w4bv1e_wcygJSzQw/exec?mode=json";

  let LANG='nl', chart;

  // ===== Helpers =====
  const euro = v => (v==null||v==='') ? 'â€“'
    : new Intl.NumberFormat(LANG==='fr'?'fr-BE':'nl-BE',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(Number(v));
  const toNum = v => {
    if (v==null||v==='') return null;
    if (typeof v==='number') return isFinite(v)&&v>0?v:null;
    const s=String(v).replace(/[â‚¬\s]/g,'').replace(',','.');
    const n=Number(s); return isFinite(n)&&n>0?n:null;
  };
  const formatBE = iso => {
    if(!iso) return 'â€“';
    const d=new Date(iso+'T00:00:00');
    return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`
  };
  function weekLabelFromDateISO(iso){
    const date=new Date(iso+'T00:00:00');
    const target=new Date(date);
    const dayNr=(date.getDay()+6)%7;
    target.setDate(target.getDate()-dayNr+3);
    const firstThu=new Date(target.getFullYear(),0,4);
    const firstThuDayNr=(firstThu.getDay()+6)%7;
    firstThu.setDate(firstThu.getDate()-firstThuDayNr+3);
    const week=1+Math.round((target-firstThu)/(7*864e5));
    return 'W'+String(week).padStart(2,'0')+' '+target.getFullYear();
  }
  const niceStep=span=>{const t=Math.max(1,span/6),p=10**Math.floor(Math.log10(t)),b=t/p;return(b<=1?1:b<=2?2:b<=5?5:10)*p;};

  // seizoen: W26 jaar N â†’ W29 jaar N+1
  function seasonBounds(now=new Date()){
    const y = now.getMonth()<6 ? now.getFullYear()-1 : now.getFullYear();
    const start=isoWeekStart(y,26), end=isoWeekStart(y+1,29); end.setDate(end.getDate()+6);
    return { start, end, label:`W26 ${start.getFullYear()} â€“ W29 ${end.getFullYear()}` };
  }
  function isoWeekStart(year, week){
    const simple=new Date(year,0,1+(week-1)*7);
    let dow=simple.getDay(); if(dow===0) dow=7;
    const monday=new Date(simple); monday.setDate(simple.getDate()-dow+1);
    return monday;
  }

  // ===== Rendering =====
  function renderKPI(latest, contractKey){
    document.getElementById('kpi-quote').textContent = euro(toNum(latest.notering));
    document.getElementById('kpi-contract').textContent = euro(toNum(latest[contractKey]));
    document.getElementById('kpi-week').textContent = weekLabelFromDateISO(latest.date);
    document.getElementById('kpi-date').textContent = formatBE(latest.date);
    const b=document.getElementById('kpi-sentiment'); b.textContent=latest.marktstemming||'â€“';
    b.className = 'inline-block mt-1 px-3 py-1 rounded-full text-xs text-white ' +
      ((s=>{s=String(s||'').toLowerCase();
        if(s.includes('vast')||s.includes('ferme'))return'bg-green-600';
        if(s.includes('houd')||s.includes('soutenu'))return'bg-yellow-600';
        if(s.includes('stabiel')||s.includes('stable'))return'bg-slate-600';
        if(s.includes('rustig')||s.includes('calme'))return'bg-slate-500';
        if(s.includes('flauw')||s.includes('faible')||s.includes('neg'))return'bg-red-600';
        return'bg-slate-600';
      })(latest.marktstemming));
    document.getElementById('lastUpdate').textContent = new Date().toLocaleString(LANG==='fr'?'fr-BE':'nl-BE',{timeZone:'Europe/Brussels'});
    document.getElementById('year').textContent = new Date().getFullYear();
  }

  function renderChart(rows, contractKey){
    const labels = rows.map(r=>weekLabelFromDateISO(r.date));
    let contract = rows.map(r=>toNum(r[contractKey]));
    if(contract.every(v=>v==null)){
      const kRaw=['contract','contract_price','contractprijs'].find(k=>k in rows[0])||'contract_price';
      let last=null; contract=rows.map(r=>{const v=toNum(r[kRaw]); if(v!=null){last=v;return v}return last});
    }
    const quote = rows.map(r=>toNum(r.notering));
    const vals=[...contract,...quote].filter(v=>Number.isFinite(v)&&v>0);
    if(!vals.length){
      const ctx=document.getElementById('chart').getContext('2d');
      ctx.clearRect(0,0,9999,9999); ctx.font='14px system-ui'; ctx.fillStyle='#b00020';
      ctx.fillText('Geen cijfers beschikbaar voor dit seizoen.',10,22);
      if(chart){chart.destroy();chart=null;} return;
    }
    const lo=Math.min(...vals), hi=Math.max(...vals), span=hi-lo;
    const step=niceStep(span), pad=Math.max(10,Math.round(span*0.1));
    const yMin=Math.max(0,Math.floor((lo-pad)/step)*step), yMax=Math.ceil((hi+pad)/step)*step;

    const ctx=document.getElementById('chart').getContext('2d');
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
      type:'line',
      data:{labels,datasets:[
        {label:LANG==='fr'?'Prix contractuel (â‚¬/tonne)':'Contractprijs (â‚¬/ton)',data:contract,borderWidth:3,pointRadius:3,borderColor:'#1d2d44',stepped:true},
        {label:LANG==='fr'?'Cotation (â‚¬/tonne)':'Notering (â‚¬/ton)',data:quote,borderWidth:3,pointRadius:3,borderColor:'#748cab'}
      ]},
      options:{responsive:true,maintainAspectRatio:false,scales:{
        x:{ticks:{maxRotation:0,autoSkip:true,maxTicksLimit:22}},
        y:{min:yMin,max:yMax,ticks:{stepSize:step,callback:v=>`${v} â‚¬`}}
      },plugins:{legend:{position:'bottom'}}}
    });
  }

  async function fetchJSON(u){
    const r=await fetch(u,{cache:'no-store'}); const t=await r.text();
    if(!t) throw new Error('Lege respons'); if(t.trim().startsWith('<')) throw new Error('HTML i.p.v. JSON');
    return JSON.parse(t);
  }

  // ===== Init =====
  (async function init(){
    document.getElementById('btn-print').onclick=()=>window.print();
    document.getElementById('btn-nl').onclick=()=>{LANG='nl'; renderKPI(window.__latest, window.__contractKeyFF); renderChart(window.__rows, window.__contractKeyFF);};
    document.getElementById('btn-fr').onclick=()=>{LANG='fr'; renderKPI(window.__latest, window.__contractKeyFF); renderChart(window.__rows, window.__contractKeyFF);};

    const data=await fetchJSON(APP_SCRIPT_JSON_URL);
    const all=Array.isArray(data.rows)?data.rows:[];
    if(!all.length) throw new Error('Geen rijen');

    const keys=Object.keys(all[0]);
    const contractKeyFF=['contract_price_ff','contractprijs_ff','contract_ff'].find(k=>keys.includes(k))
      ||['contract_price','contractprijs','contract'].find(k=>keys.includes(k))
      ||'contract_price';
    window.__contractKeyFF=contractKeyFF;

    const {start,end,label}=seasonBounds(new Date());
    document.getElementById('seasonLabel').textContent=label;
    const seasonRows=all.filter(r=>{const d=new Date(r.date+'T00:00:00');return d>=start&&d<=end});
    if(!seasonRows.length) throw new Error('Geen rijen binnen seizoensinterval');

    let latest=seasonRows[seasonRows.length-1];
    window.__rows=seasonRows; window.__latest=latest;

    renderKPI(latest, contractKeyFF);
    renderChart(seasonRows, contractKeyFF);
  })().catch(err=>{
    const ctx=document.getElementById('chart').getContext('2d');
    ctx.font='14px system-ui'; ctx.fillStyle='#b00020';
    ctx.fillText('Kon data niet laden: '+err.message,10,22);
  });
  </script>
</body>
</html>
