<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Belgapom – Notering / Cotation</title>
  <meta name="description" content="Contractprijzen en wekelijkse notering voor vrije aardappelen. / Prix contractuels et cotation hebdomadaire pour pommes de terre libres." />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root { --brand-cream:#f0ebd8; --brand-navy:#0d1321; --brand-blue:#1d2d44; --brand-gray:#748cab; }
    body { background: var(--brand-cream); color: var(--brand-navy); }
    header { border-bottom: 1px solid rgba(13,19,33,.08); }
    .card { background:#fff; border-radius: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    .kpi-label { color: var(--brand-gray); font-size: 12px; }
    .kpi-value { color: var(--brand-navy); }
    .btn { padding:.5rem .75rem; border:1px solid rgba(0,0,0,.1); border-radius:.75rem; }
    .btn.active { background:#0d1321; color:#fff; border-color:#0d1321; }
    @media print { .no-print { display:none !important } body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="assets/belgapom-logo.svg" alt="Belgapom" class="h-9 w-auto" onerror="this.style.display='none'"/>
        <div>
          <h1 class="text-xl font-semibold" data-i18n="title">Belgapom – Notering</h1>
          <p class="text-sm text-gray-500" data-i18n="subtitle">Contractprijzen en wekelijkse notering </p>
        </div>
      </div>
      <div class="flex items-center gap-2 no-print">
        <div class="flex gap-1" role="group" aria-label="language switch">
          <button id="btn-nl" class="btn active">NL</button>
          <button id="btn-fr" class="btn">FR</button>
        </div>
        <button class="btn" onclick="window.print()" data-i18n="download">Download PDF</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6 grid md:grid-cols-3 gap-6">
    <!-- KPIs + Chart + Text -->
    <section class="md:col-span-2 space-y-6">
      <div class="card p-5 grid grid-cols-2 md:grid-cols-4 gap-4" id="kpis">
        <div>
          <div class="kpi-label" data-i18n="kpi_quote">Notering</div>
          <div class="kpi-value text-2xl font-semibold" id="kpi-quote">–</div>
        </div>
        <div>
          <div class="kpi-label" data-i18n="kpi_contract">Contractprijs</div>
          <div class="kpi-value text-2xl font-semibold" id="kpi-contract">–</div>
        </div>
        <div>
          <div class="kpi-label" data-i18n="kpi_week">Week</div>
          <div class="kpi-value text-2xl font-semibold" id="kpi-week">–</div>
        </div>
        <div>
          <div class="kpi-label" data-i18n="kpi_date">Datum</div>
          <div class="kpi-value text-2xl font-semibold" id="kpi-date">–</div>
        </div>
        <div class="col-span-2 md:col-span-4">
          <div class="kpi-label" data-i18n="kpi_sentiment">Marktstemming</div>
          <span id="kpi-sentiment" class="inline-block mt-1 px-3 py-1 rounded-full text-white bg-gray-600 text-sm">–</span>
        </div>
      </div>

      <div class="card p-5">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M3 4.5A1.5 1.5 0 0 1 4.5 3h15A1.5 1.5 0 0 1 21 4.5v15a1.5 1.5 0 0 1-1.5 1.5h-15A1.5 1.5 0 0 1 3 19.5v-15Zm3 3A.75.75 0 0 0 5.25 8v8a.75.75 0 0 0 1.5 0V8A.75.75 0 0 0 6 7.5Zm4.5 3A.75.75 0 0 0 9.75 11v5a.75.75 0 0 0 1.5 0v-5a.75.75 0 0 0-.75-.75ZM15 9a.75.75 0 0 0-.75.75v6.25a.75.75 0 0 0 1.5 0V9.75A.75.75 0 0 0 15 9Zm3-1.5a.75.75 0 0 0-.75.75V18a.75.75 0 0 0 1.5 0V8.25a.75.75 0 0 0-.75-.75Z"/></svg>
            <h2 class="text-lg font-semibold" data-i18n="history">Historiek</h2>
          </div>
          <div id="seasonLabel" class="text-sm text-gray-600"></div>
        </div>
        <div class="relative h-[420px]"><canvas id="chart"></canvas></div>

        <!-- Legende marktstemming -->
        <div class="mt-6 p-4 border rounded bg-slate-50 text-sm">
          <h3 class="font-semibold mb-2" data-i18n="legend_title">Legende marktstemming</h3>
          <ul class="list-disc pl-5 space-y-1">
            <li data-i18n="legend_weak"><strong>Flauw</strong> — aanbod is groter dan de vraag</li>
            <li data-i18n="legend_calm"><strong>Rustig</strong> — aanbod is groter dan of gelijk aan de vraag</li>
            <li data-i18n="legend_stable"><strong>Stabiel</strong> — aanbod is gelijk aan de vraag (evenwicht)</li>
            <li data-i18n="legend_support"><strong>Prijshoudend</strong> — aanbod is kleiner dan of gelijk aan de vraag</li>
            <li data-i18n="legend_firm"><strong>Vast</strong> — aanbod is kleiner dan de vraag</li>
          </ul>
        </div>

        <!-- Reglementering & toelichting -->
        <div class="mt-6 p-4 border rounded bg-slate-50 text-sm leading-relaxed">
          <h3 class="font-semibold mb-2" data-i18n="rules_title">Reglementering & toelichting</h3>
          <div data-i18n="rules_body">
            <p class="mb-2">Vrije markt en contracten in de Belgische diepvriesfrietsector:</p>
            <p class="mb-2">De wekelijkse Belgapomnotering voor vroege aardappelen (juli–augustus) en voor Fontane en Challenger (bewaarseizoen) geeft een duidelijke indicatie van de evolutie van de vrije aardappelmarkt voor de verwerking van aardappelen tot diepvriesfriet.</p>
            <p class="mb-2">Daarnaast maken telers, handel en verwerking in steeds grotere mate gebruik van teeltcontracten, die een grotere stabiliteit van de grondstofprijs op het oog hebben. De verhouding tussen beide instrumenten om aardappelen te kopen en verkopen kan verschillen van bedrijf tot bedrijf. Beide componenten dienen in rekening gebracht te worden om de evolutie van de grondstofprijs te volgen.</p>
            <p>Daarom toont de grafiek bij de Belgapomnotering ook de maandelijkse evolutie van de contractprijzen naast de wekelijkse notering.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Side -->
    <aside class="space-y-4">
      <div class="card p-5 text-sm text-slate-700">
        <p class="mb-2"><span data-i18n="last_update_label">Laatste update</span>: <span id="lastUpdate">–</span></p>
        <p class="mb-2" data-i18n="source">Bron: interne rapportering</p>
        <p class="text-xs">© <span id="year"></span> Belgapom</p>
      </div>
    </aside>
  </main>

  <script>
    // ====== JSON-URL ======
    const APP_SCRIPT_JSON_URL = "https://script.google.com/macros/s/AKfycbxXkCIga_MkeIkNPYtssLI9rA_sCBMUxRYYNH13ZXxj3MSkvObWk8w4bv1e_wcygJSzQw/exec?mode=json";

    // ====== I18N ======
    let LANG = 'nl';
    const I18N = {
      nl: {
        title:"Belgapom – Notering", subtitle:"Contractprijzen en wekelijkse notering (vrije aardappelen)", download:"Download PDF",
        history:"Historiek", kpi_quote:"Notering", kpi_contract:"Contractprijs", kpi_week:"Week", kpi_date:"Datum", kpi_sentiment:"Marktstemming",
        legend_title:"Legende marktstemming",
        legend_weak:"Flauw — aanbod is groter dan de vraag",
        legend_calm:"Rustig — aanbod is groter dan of gelijk aan de vraag",
        legend_stable:"Stabiel — aanbod is gelijk aan de vraag (evenwicht)",
        legend_support:"Prijshoudend — aanbod is kleiner dan of gelijk aan de vraag",
        legend_firm:"Vast — aanbod is kleiner dan de vraag",
        rules_title:"Reglementering & toelichting",
        rules_body:[
          "Vrije markt en contracten in de Belgische diepvriesfrietsector:",
          "De wekelijkse Belgapomnotering voor vroege aardappelen (juli–augustus) en voor Fontane en Challenger (bewaarseizoen) geeft een duidelijke indicatie van de evolutie van de vrije aardappelmarkt voor de verwerking van aardappelen tot diepvriesfriet.",
          "Daarnaast maken telers, handel en verwerking in steeds grotere mate gebruik van teeltcontracten, die een grotere stabiliteit van de grondstofprijs op het oog hebben. De verhouding tussen beide instrumenten om aardappelen te kopen en verkopen kan verschillen van bedrijf tot bedrijf. Beide componenten dienen in rekening gebracht te worden om de evolutie van de grondstofprijs te volgen.",
          "Daarom toont de grafiek bij de Belgapomnotering ook de maandelijkse evolutie van de contractprijzen naast de wekelijkse notering."
        ],
        last_update_label:"Laatste update", source:"Bron: interne rapportering"
      },
      fr: {
        title:"Belgapom – Cotation", subtitle:"Prix contractuels et cotation hebdomadaire (pommes de terre libres)", download:"Télécharger PDF",
        history:"Historique", kpi_quote:"Cotation", kpi_contract:"Prix contractuel", kpi_week:"Semaine", kpi_date:"Date", kpi_sentiment:"Tendance du marché",
        legend_title:"Légende – tendance du marché",
        legend_weak:"Faible — l'offre est supérieure à la demande",
        legend_calm:"Calme — l'offre est supérieure ou égale à la demande",
        legend_stable:"Stable — l'offre est égale à la demande (équilibre)",
        legend_support:"Soutenu — l'offre est inférieure ou égale à la demande",
        legend_firm:"Ferme — l'offre est inférieure à la demande",
        rules_title:"Réglementation & explications",
        rules_body:[
          "Marché libre et contrats dans le secteur belge des frites surgelées :",
          "La cotation hebdomadaire de Belgapom pour les pommes de terre précoces (juillet–août) et pour Fontane & Challenger (saison de conservation) indique clairement l’évolution du marché libre des pommes de terre destinées à la transformation en frites surgelées.",
          "Parallèlement, producteurs, commerce et industrie recourent de plus en plus aux contrats de culture, visant une plus grande stabilité du prix de la matière première. La part relative de ces instruments peut varier d’une entreprise à l’autre. Les deux composantes doivent être prises en compte pour suivre l’évolution du prix.",
          "C’est pourquoi le graphique de la cotation Belgapom affiche aussi l’évolution mensuelle des prix contractuels en plus de la cotation hebdomadaire."
        ],
        last_update_label:"Dernière mise à jour", source:"Source : reporting interne"
      }
    };
    function applyI18N(){
      const d = I18N[LANG];
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        const k = el.getAttribute("data-i18n"), v = d[k];
        if (Array.isArray(v)) el.innerHTML = v.map(p=>`<p class="mb-2">${p}</p>`).join("");
        else if (typeof v === "string") el.textContent = v;
      });
      document.getElementById('btn-nl').classList.toggle('active', LANG==='nl');
      document.getElementById('btn-fr').classList.toggle('active', LANG==='fr');
    }

    // ====== HELPERS ======
    const euro = v => (v==null||v==='') ? '–' : new Intl.NumberFormat('nl-BE',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(Number(v));
    const toNum = v => {
      if (v == null) return null;
      if (typeof v === 'number') return isFinite(v) && v>0 ? v : null;
      if (typeof v === 'string') {
        // strip € en spaties, vervang komma naar punt
        const s = v.replace(/[€\s]/g,'').replace(',', '.');
        const n = Number(s);
        return (isFinite(n) && n>0) ? n : null;
      }
      return null;
    };
    function badgeClass(s){
      s = String(s||'').toLowerCase();
      if (s.includes('vast')||s.includes('ferme')) return 'bg-green-600';
      if (s.includes('prijshoud')||s.includes('soutenu')) return 'bg-yellow-600';
      if (s.includes('stabiel')||s.includes('stable')) return 'bg-gray-600';
      if (s.includes('rustig')||s.includes('calme')) return 'bg-gray-500';
      if (s.includes('flauw')||s.includes('faible')||s.includes('negatief')||s.includes('négatif')) return 'bg-red-600';
      return 'bg-gray-500';
    }
    async function fetchJSON(u){
      const r = await fetch(u, { cache:'no-store' });
      const t = await r.text();
      if (!t) throw new Error('Lege respons');
      if (t.trim().startsWith('<')) throw new Error('Server gaf HTML terug i.p.v. JSON');
      try { return JSON.parse(t); } catch(e){ throw new Error('Ongeldig JSON: '+e.message); }
    }
    function formatBE(iso){
      if (!iso) return '–';
      const d = new Date(iso + 'T00:00:00');
      return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    }
    function niceStep(span){
      const target = Math.max(1, span/7), pow10 = 10 ** Math.floor(Math.log10(target)), base = target/pow10;
      return (base<=1?1:base<=2?2:base<=5?5:10) * pow10;
    }

    // ====== Seizoensfilter (fixed: W30 2024 → W29 2025) ======
    const SEASON_FIXED = { startYear: 2024, startWeek: 30, endYear: 2025, endWeek: 29 };
    function isoWeekStartDate(year, week){
      const simple = new Date(year, 0, 1 + (week - 1) * 7);
      let dow = simple.getDay(); if (dow === 0) dow = 7;
      const monday = new Date(simple);
      monday.setDate(simple.getDate() - dow + 1);
      return new Date(monday.getFullYear(), monday.getMonth(), monday.getDate());
    }
    function seasonBounds(){
      const start = isoWeekStartDate(SEASON_FIXED.startYear, SEASON_FIXED.startWeek);
      const end   = isoWeekStartDate(SEASON_FIXED.endYear,   SEASON_FIXED.endWeek); end.setDate(end.getDate()+6);
      return { start, end, label: `W${SEASON_FIXED.startWeek} ${SEASON_FIXED.startYear} – W${SEASON_FIXED.endWeek} ${SEASON_FIXED.endYear}` };
    }

    // ====== Contract key autodetect ======
    function detectContractKey(sampleRow){
      const candidates = ['contract_price_ff','contract_price','contract','Contractprijs','Contract','contractprijs'];
      for (const k of candidates){
        if (k in sampleRow) return k;
      }
      // fallback: zoek eerste numerieke key die niet 'notering' heet
      for (const [k,v] of Object.entries(sampleRow)){
        if (k.toLowerCase().includes('notering')) continue;
        if (toNum(v) != null) return k;
      }
      return null;
    }

    let chart;

    function renderKPI(latest, contractKey){
      document.getElementById('kpi-quote').textContent = euro(latest.notering);
      const cVal = toNum(latest[contractKey]);
      document.getElementById('kpi-contract').textContent = euro(cVal);
      document.getElementById('kpi-week').textContent = latest.week || '–';
      document.getElementById('kpi-date').textContent = formatBE(latest.date);
      const b = document.getElementById('kpi-sentiment');
      b.textContent = latest.marktstemming || '–';
      b.className = 'inline-block mt-1 px-3 py-1 rounded-full text-white text-sm ' + badgeClass(latest.marktstemming);
      document.getElementById('lastUpdate').textContent = new Date().toLocaleString('nl-BE', { timeZone:'Europe/Brussels' });
      document.getElementById('year').textContent = new Date().getFullYear();
    }

    function renderChart(rows, contractKey){
      const labels = rows.map(r => r.week || formatBE(r.date));

      // ---- CONTRACT: parse + forward fill + backfill
      const parsedContract = rows.map(r => toNum(r[contractKey]));
      // forward fill
      let last = null;
      const ff = parsedContract.map(v => {
        if (v != null) { last = v; return v; }
        return (last != null ? last : null);
      });
      // backfill tot aan eerste bekende
      const firstIdx = ff.findIndex(v => v != null);
      if (firstIdx > 0 && ff[firstIdx] != null) {
        for (let i=0;i<firstIdx;i++) ff[i] = ff[firstIdx];
      }
      const contract = ff;

      // ---- NOTERING
      const quote = rows.map(r => toNum(r.notering));

      // schaalbepaling
      const vals = [...contract, ...quote].filter(v => Number.isFinite(v) && v>0);
      let yMin=0, yMax=100, step=10;
      if (vals.length){
        const sorted=[...vals].sort((a,b)=>a-b), mid=Math.floor(sorted.length/2);
        const median = sorted.length%2 ? sorted[mid] : (sorted[mid-1]+sorted[mid])/2;
        const rawMin=sorted[0], rawMax=sorted[sorted.length-1];
        const effMin=Math.max(0, Math.max(rawMin, median*0.6)), effMax=rawMax;
        const span=Math.max(1, effMax-effMin), pad=Math.max(10, Math.round(span*0.10));
        step = niceStep(span);
        yMin = Math.max(0, Math.floor((effMin-pad)/step)*step);
        yMax = Math.ceil((effMax+pad)/step)*step;
        if (yMax<=yMin) yMax=yMin+step;
      }

      const ctx = document.getElementById('chart');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'line',
        data:{
          labels,
          datasets:[
            {
              label: (LANG==='fr'?'Prix contractuel (€/tonne)':'Contractprijs (€/ton)'),
              data: contract,
              borderWidth: 3,
              pointRadius: 4,
              borderColor: '#1d2d44',
              backgroundColor: 'transparent',
              spanGaps: true,
              stepped: true
            },
            {
              label: (LANG==='fr'?'Cotation (€/tonne)':'Notering (€/ton)'),
              data: quote,
              borderWidth: 3,
              pointRadius: 3,
              borderColor: '#748cab',
              backgroundColor: 'transparent',
              spanGaps: true
            }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false, interaction:{ mode:'index', intersect:false },
          scales:{ y:{ min:yMin, max:yMax, beginAtZero:false, ticks:{ stepSize:step, callback:v=>`${v} €` } } },
          plugins:{ legend:{ position:'bottom' } }
        }
      });
    }

    async function init(){
      // taal-schakelaar
      document.getElementById('btn-nl').onclick = ()=>{ LANG='nl'; applyI18N(); if (window.__seasonRows){ renderKPI(window.__latest, window.__contractKey); renderChart(window.__seasonRows, window.__contractKey);} };
      document.getElementById('btn-fr').onclick = ()=>{ LANG='fr'; applyI18N(); if (window.__seasonRows){ renderKPI(window.__latest, window.__contractKey); renderChart(window.__seasonRows, window.__contractKey);} };
      applyI18N();

      try{
        const data = await fetchJSON(APP_SCRIPT_JSON_URL);
        const all = Array.isArray(data.rows)? data.rows : [];
        if (!all.length) throw new Error('Geen rijen in data');

        // sorteer voor zekerheid
        all.sort((a,b)=> a.date.localeCompare(b.date));

        // Detecteer contract key op basis van de eerste rij die een contract-achtige waarde heeft
        let contractKey = 'contract_price';
        for (const r of all){
          const k = detectContractKey(r);
          if (k){ contractKey = k; break; }
        }

        const { start, end, label } = seasonBounds();
        document.getElementById('seasonLabel').textContent = label;

        const seasonRows = all.filter(r => {
          const d = new Date(r.date + 'T00:00:00');
          return d >= start && d <= end;
        });
        if (!seasonRows.length) throw new Error('Geen rijen binnen seizoensinterval');

        // Actueel: laatste vrijdag → donderdag binnen het seizoen
        const nowBE = new Date(new Date().toLocaleString('en-US', { timeZone:'Europe/Brussels' }));
        const day = nowBE.getDay(); // 0=zo .. 5=vr
        const offsetToFriday = (day>=5) ? (day-5) : (day+2);
        const lastFriday = new Date(nowBE); lastFriday.setDate(nowBE.getDate()-offsetToFriday);
        const cutoffIso = lastFriday.toISOString().slice(0,10);

        let latest = seasonRows[seasonRows.length-1];
        for (let i=seasonRows.length-1;i>=0;i--) if (seasonRows[i].date <= cutoffIso){ latest = seasonRows[i]; break; }

        // stash
        window.__seasonRows = seasonRows;
        window.__latest = latest;
        window.__contractKey = contractKey;

        renderKPI(latest, contractKey);
        renderChart(seasonRows, contractKey);
      }catch(err){
        document.getElementById('kpis').innerHTML = `<div class="text-sm text-red-700">Kon data niet laden: ${err.message}.</div>`;
        const ctx = document.getElementById('chart').getContext('2d');
        ctx.font='14px system-ui'; ctx.fillStyle='#999'; ctx.fillText('Geen data beschikbaar / Pas de données',10,20);
      }
    }

    init();
  </script>
</body>
</html>
