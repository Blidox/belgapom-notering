<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Belgapom – Notering / Cotation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root{ --primeur: rgba(255,206,86,.22) }
    @media print{ .no-print{ display:none !important } }
  </style>
</head>
<body class="bg-[#f0ebd8] text-[#0d1321]">

  <!-- Header -->
  <header class="sticky top-0 z-10 bg-white/85 backdrop-blur border-b border-black/10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div>
        <h1 id="title" class="font-semibold text-lg">Belgapom – Notering</h1>
        <p id="subtitle" class="text-sm text-slate-600">Contractprijzen en wekelijkse notering (vrije aardappelen)</p>
      </div>
      <div class="flex gap-2 no-print">
        <button id="btn-nl" class="px-3 py-1.5 rounded-lg border border-black/20 bg-white">NL</button>
        <button id="btn-fr" class="px-3 py-1.5 rounded-lg border border-black/20">FR</button>
        <button id="btn-print" class="px-3 py-1.5 rounded-lg border border-black/20">PDF</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6 grid md:grid-cols-3 gap-6">
    <!-- Left: KPIs + Chart + Info -->
    <section class="md:col-span-2 space-y-4">
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold">Historiek</h2>
          <div id="seasonLabel" class="text-sm text-slate-600"></div>
        </div>

        <!-- KPIs -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 text-sm">
          <div><div class="text-slate-500" data-i18n="kpi_quote">Notering</div><div id="kpi-quote" class="text-xl font-semibold">–</div></div>
          <div><div class="text-slate-500" data-i18n="kpi_contract">Contractprijs</div><div id="kpi-contract" class="text-xl font-semibold">–</div></div>
          <div><div class="text-slate-500" data-i18n="kpi_week">Week</div><div id="kpi-week" class="text-xl font-semibold">–</div></div>
          <div><div class="text-slate-500" data-i18n="kpi_date">Datum</div><div id="kpi-date" class="text-xl font-semibold">–</div></div>
          <div class="col-span-2 md:col-span-4">
            <div class="text-slate-500" data-i18n="kpi_sentiment">Marktstemming</div>
            <span id="kpi-sentiment" class="inline-block mt-1 px-3 py-1 rounded-full text-white bg-slate-600 text-xs">–</span>
          </div>
        </div>

        <!-- Chart -->
        <div class="relative h-[420px]">
          <canvas id="chart" aria-label="Grafiek contractprijs & notering" role="img"></canvas>
        </div>

        <!-- Legende marktstemming -->
        <div class="mt-4 p-4 rounded-xl border border-black/10 bg-slate-50 text-sm">
          <h3 class="font-semibold mb-2" data-i18n="legend_title">Legende marktstemming</h3>
          <ul class="list-disc pl-5 space-y-1">
            <li data-i18n="legend_weak"><strong>Flauw</strong> — aanbod is groter dan de vraag</li>
            <li data-i18n="legend_calm"><strong>Rustig</strong> — aanbod is groter dan of gelijk aan de vraag</li>
            <li data-i18n="legend_stable"><strong>Stabiel</strong> — aanbod is gelijk aan de vraag (evenwicht)</li>
            <li data-i18n="legend_support"><strong>Prijshoudend</strong> — aanbod is kleiner dan of gelijk aan de vraag</li>
            <li data-i18n="legend_firm"><strong>Vast</strong> — aanbod is kleiner dan de vraag</li>
          </ul>
        </div>

        <!-- Reglementering -->
        <div class="mt-4 p-4 rounded-xl border border-black/10 bg-slate-50 text-sm leading-relaxed">
          <h3 class="font-semibold mb-2" data-i18n="rules_title">Reglementering & toelichting</h3>
          <div id="rules_body">
            <p>De wekelijkse Belgapomnotering voor vroege aardappelen (juli–augustus) en voor Fontane en Challenger (bewaarseizoen) geeft een duidelijke indicatie van de evolutie van de vrije aardappelmarkt voor de verwerking van aardappelen tot diepvriesfriet.</p>
            <p>Daarnaast maken telers, handel en verwerking in steeds grotere mate gebruik van teeltcontracten, die een grotere stabiliteit van de grondstofprijs op het oog hebben. De verhouding tussen beide instrumenten kan verschillen per bedrijf. Beide componenten dienen in rekening gebracht te worden om de evolutie van de grondstofprijs te volgen.</p>
            <p>Daarom toont de grafiek bij de Belgapomnotering ook de evolutie van de contractprijzen naast de wekelijkse notering.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Right: Meta + Table -->
    <aside class="space-y-4">
      <div class="bg-white rounded-2xl shadow p-4 text-sm text-slate-700">
        <p class="mb-2"><span data-i18n="last_update_label">Laatste update</span>: <span id="lastUpdate">–</span></p>
        <p class="mb-2" data-i18n="source">Bron: interne rapportering</p>
        <p class="text-xs">© <span id="year"></span> Belgapom</p>
      </div>

      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between gap-2">
          <strong data-i18n="table_title">Overzicht per week</strong>
          <div class="text-sm text-slate-600" id="tableYear"></div>
        </div>
        <div class="max-h-[360px] overflow-auto mt-3">
          <table class="w-full text-sm">
            <thead class="text-left text-slate-600 sticky top-0 bg-white">
              <tr><th>Week</th><th data-i18n="th_date">Datum (ma)</th><th data-i18n="th_contract">Contract</th><th data-i18n="th_quote">Notering</th><th data-i18n="th_sent">Stemming</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <p class="mt-2 text-xs text-slate-500" id="primeurNote">Primeurperiode (lichtgeel): 3e week van juli t/m 3e week van september.</p>
      </div>
    </aside>
  </main>

  <script>
  // ========= CONFIG =========
  const APP_SCRIPT_JSON_URL = "https://script.google.com/macros/s/AKfycbz2-3EOEweJfn71NDO6ShllhRbS6dHjbSVuxY_ycWiLvibTB9Vw20hEoOSwtRiPDiRktw/exec?mode=json";

  // ========= I18N =========
  let LANG = (new URLSearchParams(location.search).get('lang')) || 'nl';
  const T = {
    nl: {
      title:"Belgapom – Notering", subtitle:"Contractprijzen en wekelijkse notering (vrije aardappelen)",
      kpi_quote:"Notering", kpi_contract:"Contractprijs", kpi_week:"Week", kpi_date:"Datum", kpi_sentiment:"Marktstemming",
      last_update_label:"Laatste update", source:"Bron: interne rapportering",
      table_title:"Overzicht per week", th_date:"Datum (ma)", th_contract:"Contract", th_quote:"Notering", th_sent:"Stemming",
      legend_title:"Legende marktstemming",
      legend_weak:"Flauw — aanbod is groter dan de vraag",
      legend_calm:"Rustig — aanbod is groter dan of gelijk aan de vraag",
      legend_stable:"Stabiel — aanbod is gelijk aan de vraag (evenwicht)",
      legend_support:"Prijshoudend — aanbod is kleiner dan of gelijk aan de vraag",
      legend_firm:"Vast — aanbod is kleiner dan de vraag",
      rules_title:"Reglementering & toelichting"
    },
    fr: {
      title:"Belgapom – Cotation", subtitle:"Prix contractuels et cotation hebdomadaire (pommes de terre libres)",
      kpi_quote:"Cotation", kpi_contract:"Prix contractuel", kpi_week:"Semaine", kpi_date:"Date", kpi_sentiment:"Tendance du marché",
      last_update_label:"Dernière mise à jour", source:"Source : reporting interne",
      table_title:"Aperçu par semaine", th_date:"Date (lun)", th_contract:"Contrat", th_quote:"Cotation", th_sent:"Ambiance",
      legend_title:"Légende – tendance du marché",
      legend_weak:"Faible — l'offre est supérieure à la demande",
      legend_calm:"Calme — l'offre est supérieure ou égale à la demande",
      legend_stable:"Stable — l'offre est égale à la demande (équilibre)",
      legend_support:"Soutenu — l'offre est inférieure ou égale à la demande",
      legend_firm:"Ferme — l'offre est inférieure à la demande",
      rules_title:"Réglementation & explications"
    }
  };
  function i18n(){
    const d=T[LANG];
    document.getElementById('title').textContent=d.title;
    document.getElementById('subtitle').textContent=d.subtitle;
    document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); if(d[k]) el.textContent=d[k]; });
  }

  // ========= HELPERS =========
  const euro = v => (v==null||v==='') ? '–'
    : new Intl.NumberFormat(LANG==='fr'?'fr-BE':'nl-BE',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(Number(v));
  const toNum = v => {
    if (v==null||v==='') return null;
    if (typeof v==='number') return isFinite(v)&&v>0 ? v : null;
    const s=String(v).replace(/[€\s]/g,'').replace(',','.');
    const n=Number(s); return isFinite(n)&&n>0 ? n : null;
  };
  function isoWeekStart(year, week){ const simple=new Date(year,0,1+(week-1)*7); let dow=simple.getDay(); if(dow===0) dow=7; const monday=new Date(simple); monday.setDate(simple.getDate()-dow+1); return new Date(monday.getFullYear(),monday.getMonth(),monday.getDate()); }
  function isoWeekLabel(d){ const date=new Date(d); const target=new Date(date); const dayNr=(date.getDay()+6)%7; target.setDate(target.getDate()-dayNr+3); const firstThu=new Date(target.getFullYear(),0,4); const firstThuDayNr=(firstThu.getDay()+6)%7; firstThu.setDate(firstThu.getDate()-firstThuDayNr+3); const week=1+Math.round((target-firstThu)/(7*864e5)); const y=target.getFullYear(); return { week, year:y, label:'W'+String(week).padStart(2,'0')+' '+y }; }
  function formatBE(iso){ if(!iso) return '–'; const d=new Date(iso+'T00:00:00'); return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; }

  // Primeur: 3e week van juli → 3e week van september
  function thirdWeekOfMonthMonday(year, month){ // month: 0-11
    const first = new Date(year, month, 1);
    const firstMonday = new Date(first); firstMonday.setDate(first.getDate() + ((8 - (first.getDay()||7)) % 7));
    const thirdMonday = new Date(firstMonday); thirdMonday.setDate(firstMonday.getDate() + 14);
    return new Date(thirdMonday.getFullYear(), thirdMonday.getMonth(), thirdMonday.getDate());
  }
  function primeurWeekRange(year){
    const start = thirdWeekOfMonthMonday(year, 6); // July
    const endMon = thirdWeekOfMonthMonday(year, 8); // September
    const end = new Date(endMon); end.setDate(endMon.getDate()+6); // tot eind die week
    const wStart = isoWeekLabel(start).week, wEnd = isoWeekLabel(end).week;
    return { wStart, wEnd };
  }

  // ========= STATE =========
  let chart, rows=[], yearTarget, contractKey='contract_price';

  // ========= RENDER =========
  function renderKPI(latest){
    document.getElementById('kpi-quote').textContent=euro(toNum(latest.notering));
    document.getElementById('kpi-contract').textContent=euro(toNum(latest[contractKey]));
    document.getElementById('kpi-week').textContent=isoWeekLabel(new Date(latest.date+'T00:00:00')).label;
    document.getElementById('kpi-date').textContent=formatBE(latest.date);
    const b=document.getElementById('kpi-sentiment'); b.textContent=latest.marktstemming||'–';
    const s=(latest.marktstemming||'').toLowerCase();
    b.className='inline-block mt-1 px-3 py-1 rounded-full text-white text-xs ' + (
      s.includes('vast')||s.includes('ferme') ? 'bg-green-600' :
      s.includes('houd')||s.includes('soutenu') ? 'bg-yellow-600' :
      s.includes('stabiel')||s.includes('stable') ? 'bg-slate-600' :
      s.includes('rustig')||s.includes('calme') ? 'bg-slate-500' :
      s.includes('flauw')||s.includes('faible')||s.includes('neg') ? 'bg-red-600' : 'bg-slate-600'
    );
    document.getElementById('lastUpdate').textContent=new Date().toLocaleString(LANG==='fr'?'fr-BE':'nl-BE',{timeZone:'Europe/Brussels'});
    document.getElementById('year').textContent=new Date().getFullYear();
  }

  function renderChart(weekContract, weekQuote){
    const labels = Array.from({length:52}, (_,i)=> 'W'+String(i+1).padStart(2,'0'));
    const contract = labels.map((_,i)=> weekContract[i+1] ?? null);
    const quote = labels.map((_,i)=> weekQuote[i+1] ?? null);

    // y-bounds
    const vals=[...contract,...quote].filter(v=>Number.isFinite(v)&&v>0);
    const niceStep = span => { const t=Math.max(1,span/6), p=10**Math.floor(Math.log10(t)), b=t/p; return (b<=1?1:b<=2?2:b<=5?5:10)*p; };
    let yMin=0,yMax=100,step=10;
    if (vals.length){
      const lo=Math.min(...vals), hi=Math.max(...vals), span=hi-lo, pad=Math.max(10,Math.round(span*0.1));
      step=niceStep(span); yMin=Math.max(0,Math.floor((lo-pad)/step)*step); yMax=Math.ceil((hi+pad)/step)*step; if(yMax<=yMin) yMax=yMin+step;
    }

    // primeurbanden
    const { wStart, wEnd } = primeurWeekRange(yearTarget);
    const bands=[{from:wStart-1, to:wEnd-1}]; // indices 0-based
    const shadePrimeur = {
      id:'shadePrimeur',
      beforeDatasetsDraw(c,args){
        const {ctx, chartArea, scales:{x}}=c; if(!chartArea) return;
        const {top,bottom}=chartArea; ctx.save(); ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--primeur')||'rgba(255,206,86,.22)';
        bands.forEach(b=>{ const x0=x.getPixelForValue(b.from); const x1=x.getPixelForValue(b.to); ctx.fillRect(x0, top, x1-x0, bottom-top); });
        ctx.restore();
      }
    };

    const ctx=document.getElementById('chart').getContext('2d');
    if (chart) chart.destroy();
    chart=new Chart(ctx,{
      type:'line',
      data:{
        labels,
        datasets:[
          { label: LANG==='fr'?'Prix contractuel (€/tonne)':'Contractprijs (€/ton)',
            data: contract, borderWidth:3, pointRadius:3, borderColor:'#1d2d44', backgroundColor:'transparent',
            stepped:true, spanGaps:false }, // geen lijnen over gaten
          { label: LANG==='fr'?'Cotation (€/tonne)':'Notering (€/ton)',
            data: quote, borderWidth:3, pointRadius:3, borderColor:'#748cab', backgroundColor:'transparent',
            spanGaps:false }
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false, interaction:{mode:'index', intersect:false},
        scales:{
          x:{ type:'category', ticks:{ maxRotation:0, autoSkip:false }},
          y:{ min:yMin, max:yMax, ticks:{ stepSize:step, callback:v=>`${v} €` } }
        },
        plugins:{ legend:{ position:'bottom' } }
      },
      plugins:[shadePrimeur]
    });
  }

  function renderTable(weekContract, weekQuote, weekSent){
    const tb=document.getElementById('tbody'); tb.innerHTML='';
    for(let w=1; w<=52; w++){
      const monday=isoWeekStart(yearTarget,w);
      const tr=document.createElement('tr');
      tr.className="border-b border-slate-100";
      tr.innerHTML=`<td class="py-1.5 pr-2">W${String(w).padStart(2,'0')}</td>
        <td class="py-1.5 pr-2">${formatBE(monday.toISOString().slice(0,10))}</td>
        <td class="py-1.5 pr-2">${euro(weekContract[w] ?? null)}</td>
        <td class="py-1.5 pr-2">${euro(weekQuote[w] ?? null)}</td>
        <td class="py-1.5">${weekSent[w] ?? '–'}</td>`;
      // primeur highlight in tabel
      const { wStart, wEnd } = primeurWeekRange(yearTarget);
      if (w>=wStart && w<=wEnd){ tr.style.background='rgba(255,206,86,.12)'; }
      tb.appendChild(tr);
    }
    document.getElementById('tableYear').textContent = yearTarget;
  }

  // ========= DATA FLOW =========
  async function fetchJSON(u){
    const r=await fetch(u,{cache:'no-store'}); const t=await r.text();
    if(!t) throw new Error('Lege respons');
    if (t.trim().startsWith('<')) throw new Error('HTML i.p.v. JSON');
    return JSON.parse(t);
  }

  (async function init(){
    i18n();
    document.getElementById('btn-print').onclick=()=>window.print();
    document.getElementById('btn-nl').onclick=()=>{LANG='nl'; i18n(); renderKPI(latest); renderChart(weekContract, weekQuote); renderTable(weekContract, weekQuote, weekSent);};
    document.getElementById('btn-fr').onclick=()=>{LANG='fr'; i18n(); renderKPI(latest); renderChart(weekContract, weekQuote); renderTable(weekContract, weekQuote, weekSent);};

    const data = await fetchJSON(APP_SCRIPT_JSON_URL);
    rows = Array.isArray(data.rows)? data.rows : [];
    if (!rows.length) throw new Error('Geen rijen in feed');

    // contract key autodetect
    contractKey = ['contract_price','contractprijs','contract'].find(k=>k in rows[0]) || 'contract_price';

    // kies doeljaar = jaar van meest recente rij
    const last = rows[rows.length-1];
    yearTarget = last.week_year || new Date(last.date+'T00:00:00').getFullYear();
    document.getElementById('seasonLabel').textContent = (LANG==='fr'?'Année ':'Jaar ') + yearTarget;

    // Bouw week-indexen 1..52 (alleen waarden op weken waar data is)
    window.weekContract = {}; window.weekQuote = {}; window.weekSent = {};
    rows.filter(r => (r.week_year===yearTarget)).forEach(r=>{
      const w = r.week_num ?? isoWeekLabel(new Date(r.date+'T00:00:00')).week;
      if (toNum(r[contractKey])!=null) weekContract[w] = toNum(r[contractKey]);
      if (toNum(r.notering)!=null) weekQuote[w]   = toNum(r.notering);
      if (r.marktstemming) weekSent[w] = r.marktstemming;
    });

    // Kies "latest" = laatste rij van het jaar ≤ vandaag; anders laatste beschikbaar
    const today = new Date(); const cutoffIso = today.toISOString().slice(0,10);
    let latestYearRows = rows.filter(r=> r.week_year===yearTarget);
    let latest = latestYearRows[latestYearRows.length-1];
    for (let i=latestYearRows.length-1;i>=0;i--) if (latestYearRows[i].date <= cutoffIso) { latest = latestYearRows[i]; break; }
    window.latest = latest;

    renderKPI(latest);
    renderChart(weekContract, weekQuote);
    renderTable(weekContract, weekQuote, weekSent);
  })().catch(err=>{
    const ctx=document.getElementById('chart').getContext('2d');
    ctx.font='14px system-ui'; ctx.fillStyle='#b00020';
    ctx.fillText('Kon data niet laden: '+err.message,10,22);
  });
  </script>
</body>
</html>
