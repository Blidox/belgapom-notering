<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Belgapom – Notering / Cotation</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root { --brand-cream:#f0ebd8; --brand-navy:#0d1321; --brand-blue:#1d2d44; --brand-gray:#748cab; }
    body { background: var(--brand-cream); color: var(--brand-navy); }
    header { border-bottom: 1px solid rgba(13,19,33,.08); }
    .card { background:#fff; border-radius: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    .kpi-label { color: var(--brand-gray); font-size: 12px; }
    .kpi-value { color: var(--brand-navy); }
    .btn { padding:.5rem .75rem; border:1px solid rgba(0,0,0,.1); border-radius:.75rem; }
    .btn.active { background:#0d1321; color:#fff; border-color:#0d1321; }
  </style>
</head>
<body>
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="assets/belgapom-logo.svg" alt="Belgapom" class="h-9 w-auto" onerror="this.style.display='none'"/>
        <div>
          <h1 class="text-xl font-semibold">Belgapom – Notering</h1>
          <p class="text-sm text-gray-500">Contractprijzen en wekelijkse notering</p>
        </div>
      </div>
      <div class="flex items-center gap-2 no-print">
        <div class="flex gap-1" role="group" aria-label="language switch">
          <button id="btn-nl" class="btn active">NL</button>
          <button id="btn-fr" class="btn">FR</button>
        </div>
        <button class="btn" onclick="window.print()">Download PDF</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 grid md:grid-cols-3 gap-6">
    <section class="md:col-span-2 space-y-6">
      <div class="card p-5 grid grid-cols-2 md:grid-cols-4 gap-4" id="kpis">
        <div><div class="kpi-label">Notering</div><div class="kpi-value text-2xl font-semibold" id="kpi-quote">–</div></div>
        <div><div class="kpi-label">Contractprijs</div><div class="kpi-value text-2xl font-semibold" id="kpi-contract">–</div></div>
        <div><div class="kpi-label">Week</div><div class="kpi-value text-2xl font-semibold" id="kpi-week">–</div></div>
        <div><div class="kpi-label">Datum</div><div class="kpi-value text-2xl font-semibold" id="kpi-date">–</div></div>
      </div>

      <div class="card p-5">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M3 4.5A1.5 1.5 0 0 1 4.5 3h15A1.5 1.5 0 0 1 21 4.5v15a1.5 1.5 0 0 1-1.5 1.5h-15A1.5 1.5 0 0 1 3 19.5v-15Z"/></svg>
            <h2 class="text-lg font-semibold">Historiek</h2>
          </div>
          <div id="seasonLabel" class="text-sm text-gray-600"></div>
        </div>
        <div class="relative h-[420px]"><canvas id="chart"></canvas></div>
      </div>
    </section>

    <aside class="space-y-4">
      <div class="card p-5 text-sm text-slate-700">
        <p class="mb-2">Laatste update: <span id="lastUpdate">–</span></p>
        <p class="text-xs">© <span id="year"></span> Belgapom</p>
      </div>
    </aside>
  </main>

  <script>
    // ========== JSON-URL (gebruik jouw nieuwste URL) ==========
    const APP_SCRIPT_JSON_URL = "https://script.google.com/macros/s/AKfycbxXkCIga_MkeIkNPYtssLI9rA_sCBMUxRYYNH13ZXxj3MSkvObWk8w4bv1e_wcygJSzQw/exec?mode=json";

    // Helpers
    const euro = v => (v==null||v==='') ? '–' : new Intl.NumberFormat('nl-BE',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(Number(v));
    const toNum = v => {
      if (v == null) return null;
      if (typeof v === 'number') return isFinite(v) && v>0 ? v : null;
      if (typeof v === 'string') {
        const s = v.replace(/€/g,'').replace(/eur/gi,'').replace(/\s+/g,'').replace(',', '.');
        const n = Number(s);
        return (isFinite(n) && n>0) ? n : null;
      }
      return null;
    };
    async function fetchJSON(u){
      const r = await fetch(u, { cache:'no-store' });
      const t = await r.text();
      if (!t) throw new Error('Lege respons');
      if (t.trim().startsWith('<')) throw new Error('Server gaf HTML terug i.p.v. JSON');
      return JSON.parse(t);
    }
    function formatBE(iso){ if (!iso) return '–'; const d = new Date(iso+'T00:00:00'); return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; }
    function niceStep(span){ const target=Math.max(1,span/7), p=10**Math.floor(Math.log10(target)), b=target/p; return (b<=1?1:b<=2?2:b<=5?5:10)*p; }

    // Seizoensfilter: W30 2024 → W29 2025
    const SEASON_FIXED = { startYear: 2024, startWeek: 30, endYear: 2025, endWeek: 29 };
    function isoWeekStartDate(year, week){
      const simple = new Date(year,0,1+(week-1)*7); let dow=simple.getDay(); if(dow===0) dow=7;
      const monday = new Date(simple); monday.setDate(simple.getDate()-dow+1); return new Date(monday.getFullYear(), monday.getMonth(), monday.getDate());
    }
    function seasonBounds(){ const s=isoWeekStartDate(SEASON_FIXED.startYear, SEASON_FIXED.startWeek); const e=isoWeekStartDate(SEASON_FIXED.endYear, SEASON_FIXED.endWeek); e.setDate(e.getDate()+6); return {start:s, end:e, label:`W${SEASON_FIXED.startWeek} ${SEASON_FIXED.startYear} – W${SEASON_FIXED.endWeek} ${SEASON_FIXED.endYear}`}; }

    // Contract key autodetect (voorkeur NL + FF varianten)
    function detectContractKey(row){
      const prefer = ['contractprijs_ff','contract_price_ff','contractprijs','contract_price'];
      for (const k of prefer) if (k in row) return k;
      const candidates = ['contract','Contract','price_contract'];
      for (const k of candidates) if (k in row) return k;
      for (const [k,v] of Object.entries(row)){ if (k.toLowerCase().includes('notering')) continue; if (toNum(v)!=null) return k; }
      return null;
    }

    let chart;

    function renderKPI(latest, contractKey){
      document.getElementById('kpi-quote').textContent = euro(latest.notering ?? latest.Notering);
      document.getElementById('kpi-contract').textContent = euro(toNum(latest[contractKey]));
      document.getElementById('kpi-week').textContent = latest.week || '–';
      document.getElementById('kpi-date').textContent = formatBE(latest.date);
      document.getElementById('lastUpdate').textContent = new Date().toLocaleString('nl-BE', { timeZone:'Europe/Brussels' });
      document.getElementById('year').textContent = new Date().getFullYear();
    }

    function renderChart(rows, contractKey){
      const labels = rows.map(r => r.week || formatBE(r.date));

      // CONTRACT: parse + forward fill + backfill
      const parsedC = rows.map(r => toNum(r[contractKey]));
      let last = null;
      const ff = parsedC.map(v => (v != null ? (last=v) : last));
      const firstIdx = ff.findIndex(v => v != null);
      if (firstIdx > 0 && ff[firstIdx] != null) for (let i=0;i<firstIdx;i++) ff[i] = ff[firstIdx];
      const contract = ff;

      // NOTERING
      const quote = rows.map(r => toNum(r.notering ?? r.Notering));

      // Y-as
      const vals = [...contract, ...quote].filter(v => Number.isFinite(v) && v>0);
      let yMin=0, yMax=100, step=10;
      if (vals.length){
        const sorted=[...vals].sort((a,b)=>a-b), mid=Math.floor(sorted.length/2);
        const median = sorted.length%2 ? sorted[mid] : (sorted[mid-1]+sorted[mid])/2;
        const rawMin=sorted[0], rawMax=sorted[sorted.length-1];
        const effMin=Math.max(0, Math.max(rawMin, median*0.6)), effMax=rawMax;
        const span=Math.max(1, effMax-effMin), pad=Math.max(10, Math.round(span*0.10));
        step = niceStep(span);
        yMin = Math.max(0, Math.floor((effMin-pad)/step)*step);
        yMax = Math.ceil((effMax+pad)/step)*step;
        if (yMax<=yMin) yMax=yMin+step;
      }

      const ctx = document.getElementById('chart');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'line',
        data:{
          labels,
          datasets:[
            { label:'Contractprijs (€/ton)', data: contract, borderWidth:3, pointRadius:4, borderColor:'#1d2d44', backgroundColor:'transparent', spanGaps:true, stepped:true },
            { label:'Notering (€/ton)',      data: quote,    borderWidth:3, pointRadius:3, borderColor:'#748cab', backgroundColor:'transparent', spanGaps:true }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false, interaction:{ mode:'index', intersect:false },
          scales:{ y:{ min:yMin, max:yMax, beginAtZero:false, ticks:{ stepSize:step, callback:v=>`${v} €` } } },
          plugins:{ legend:{ position:'bottom' } }
        }
      });
    }

    async function init(){
      document.getElementById('btn-nl').onclick = ()=>{ renderKPI(window.__latest, window.__contractKey); renderChart(window.__seasonRows, window.__contractKey); };
      document.getElementById('btn-fr').onclick = ()=>{ renderKPI(window.__latest, window.__contractKey); renderChart(window.__seasonRows, window.__contractKey); };

      try{
        const data = await fetchJSON(APP_SCRIPT_JSON_URL);
        const all = Array.isArray(data.rows)? data.rows : [];
        if (!all.length) throw new Error('Geen rijen in data');

        all.sort((a,b)=> a.date.localeCompare(b.date));

        const { start, end, label } = seasonBounds();
        document.getElementById('seasonLabel').textContent = label;

        const seasonRows = all.filter(r => {
          const d = new Date(r.date + 'T00:00:00');
          return d >= start && d <= end;
        });
        if (!seasonRows.length) throw new Error('Geen rijen binnen seizoensinterval');

        // Detecteer beste sleutel (NL/EN, FF)
        let contractKey = detectContractKey(seasonRows.find(r => toNum(r.contractprijs ?? r.contract_price ?? r.contractprijs_ff ?? r.contract_price_ff ?? r.contract) != null) || seasonRows[0]);
        if (!contractKey) contractKey = 'contract_price_ff';  // veilige fallback

        // Actueel = laatste vrijdag <= vandaag
        const nowBE = new Date(new Date().toLocaleString('en-US', { timeZone:'Europe/Brussels' }));
        const day = nowBE.getDay(); const offsetToFriday = (day>=5) ? (day-5) : (day+2);
        const lastFriday = new Date(nowBE); lastFriday.setDate(nowBE.getDate()-offsetToFriday);
        const cutoffIso = lastFriday.toISOString().slice(0,10);
        let latest = seasonRows[seasonRows.length-1];
        for (let i=seasonRows.length-1;i>=0;i--) if (seasonRows[i].date <= cutoffIso){ latest = seasonRows[i]; break; }

        // debug in console
        const nonNullCount = seasonRows.filter(r => toNum(r[contractKey]) != null).length;
        console.log('Contract key:', contractKey, 'non-null in season:', nonNullCount);

        window.__seasonRows = seasonRows;
        window.__latest = latest;
        window.__contractKey = contractKey;

        renderKPI(latest, contractKey);
        renderChart(seasonRows, contractKey);
      }catch(err){
        document.getElementById('kpis').innerHTML = `<div class="text-sm text-red-700">Kon data niet laden: ${err.message}.</div>`;
        const ctx = document.getElementById('chart').getContext('2d');
        ctx.font='14px system-ui'; ctx.fillStyle='#999'; ctx.fillText('Geen data beschikbaar / Pas de données',10,20);
      }
    }

    init();
  </script>
</body>
</html>
