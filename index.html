<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light">
  <meta name="theme-color" content="#f0ebd8">
  <title>Belgapom – Notering / Cotation / Quotation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    /* Print */
    @media print { .no-print { display:none !important } header.sticky{position:static} }
    /* Small helpers */
    .spinner{ width:24px;height:24px;border:3px solid rgba(0,0,0,.15);border-top-color:rgba(0,0,0,.6);border-radius:50%;animation:spin .9s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.8);backdrop-filter:blur(2px)}
    .loading-hidden{display:none!important}
    /* Horizontal scroll hint for mobile tables */
    .scroll-shadow{position:relative}
    .scroll-shadow::after{content:"";position:absolute;top:0;right:0;width:28px;height:100%;pointer-events:none;background:linear-gradient(90deg,rgba(255,255,255,0),rgba(255,255,255,1));}
    .scroll-shadow.scrolled::after{opacity:0;}
  </style>
</head>
<body class="bg-[#f0ebd8] text-[#0d1321] selection:bg-[#1d2d44]/10">
  <!-- Header -->
  <header class="sticky top-0 z-10 bg-white/85 backdrop-blur border-b border-black/10">
    <div class="max-w-6xl mx-auto px-3 sm:px-4 py-2.5 sm:py-3 flex items-center justify-between gap-3">
      <div class="min-w-0">
        <h1 id="title" class="font-semibold text-base sm:text-lg truncate">Belgapom – Notering</h1>
        <p id="subtitle" class="text-xs sm:text-sm text-slate-600 truncate">Contractprijzen en wekelijkse notering (vrije aardappelen)</p>
      </div>
      <!-- Segmented language control + print -->
      <div class="no-print flex items-center gap-2">
        <div class="inline-flex rounded-xl border border-black/15 overflow-hidden text-sm">
          <button id="btn-nl" class="px-2.5 sm:px-3 py-1.5 focus:outline-none focus-visible:ring-2 focus-visible:ring-[#1d2d44]" data-lang="nl">NL</button>
          <button id="btn-fr" class="px-2.5 sm:px-3 py-1.5 focus:outline-none focus-visible:ring-2 focus-visible:ring-[#1d2d44]" data-lang="fr">FR</button>
          <button id="btn-en" class="px-2.5 sm:px-3 py-1.5 focus:outline-none focus-visible:ring-2 focus-visible:ring-[#1d2d44]" data-lang="en">EN</button>
        </div>
        <button id="btn-print" class="hidden sm:inline-flex px-3 py-1.5 rounded-xl border border-black/20 bg-white text-sm">PDF</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-3 sm:px-4 py-4 sm:py-6 grid md:grid-cols-3 gap-4 sm:gap-6">
    <!-- Left -->
    <section class="md:col-span-2 space-y-4">
      <div class="bg-white rounded-2xl shadow p-3 sm:p-4">
        <div class="flex items-center justify-between mb-2 gap-2">
          <h2 class="text-base sm:text-lg font-semibold">Historiek</h2>
          <div id="seasonLabel" class="text-xs sm:text-sm text-slate-600"></div>
        </div>

        <!-- KPIs -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3 sm:mb-4 text-sm">
          <div>
            <div class="text-slate-500" data-i18n="kpi_quote">Notering</div>
            <div id="kpi-quote" class="text-xl font-semibold">–</div>
          </div>
          <div>
            <div class="text-slate-500" data-i18n="kpi_week">Week</div>
            <div id="kpi-week" class="text-xl font-semibold">–</div>
          </div>
          <div>
            <div class="text-slate-500" data-i18n="kpi_date">Datum</div>
            <div id="kpi-date" class="text-xl font-semibold">–</div>
          </div>
          <div class="col-span-2 md:col-span-3">
            <div class="text-slate-500" data-i18n="kpi_sentiment">Marktstemming</div>
            <span id="kpi-sentiment" class="inline-block mt-1 px-3 py-1 rounded-full text-white bg-slate-600 text-xs">–</span>
          </div>
        </div>

        <!-- Chart + loader -->
        <div class="relative h-[52vh] sm:h-[420px]" id="chartWrap" aria-live="polite">
          <canvas id="chart" aria-label="Grafiek contractprijs &amp; notering" role="img"></canvas>
          <div id="chartLoader" class="loading-overlay">
            <div class="flex items-center gap-3 text-slate-700">
              <div class="spinner" aria-hidden="true"></div>
              <span id="chartLoaderText">Data laden…</span>
            </div>
          </div>
        </div>

        <!-- Legend -->
        <div class="mt-4 p-3 sm:p-4 rounded-xl border border-black/10 bg-slate-50 text-sm">
          <h3 class="font-semibold mb-2" data-i18n="legend_title">Legende marktstemming</h3>
          <ul class="list-disc pl-5 space-y-1" id="legend_list"></ul>
        </div>

        <!-- Rules -->
        <div class="mt-4 p-3 sm:p-4 rounded-xl border border-black/10 bg-slate-50 text-sm leading-relaxed">
          <h3 class="font-semibold mb-2" data-i18n="rules_title">Reglementering &amp; toelichting</h3>
          <div id="rules_body"></div>
        </div>
      </div>
    </section>

    <!-- Right -->
    <aside class="space-y-4">
      <div class="bg-white rounded-2xl shadow p-3 sm:p-4 text-sm text-slate-700">
        <p class="mb-1.5"><span data-i18n="last_update_label">Laatste update</span>: <span id="lastUpdate">–</span></p>
        <p class="mb-1.5" data-i18n="source">Bron: interne rapportering</p>
        <p class="text-xs">© <span id="year"></span> Belgapom</p>
      </div>

      <div class="bg-white rounded-2xl shadow p-3 sm:p-4">
        <div class="flex items-center justify-between gap-2">
          <strong class="text-sm sm:text-base" data-i18n="table_title">Overzicht per week</strong>
          <div class="text-xs sm:text-sm text-slate-600" id="tableSeason"></div>
        </div>
        <div class="relative max-h-[360px] overflow-auto mt-3 scroll-shadow" id="tableWrap" aria-live="polite" aria-label="Tabel met overzicht per week">
          <div id="tableLoader" class="loading-overlay"><div class="flex items-center gap-3 text-slate-700">
            <div class="spinner" aria-hidden="true"></div><span id="tableLoaderText">Tabel laden…</span>
          </div></div>
          <table class="w-full text-sm min-w-[520px]">
            <thead class="text-left text-slate-600 sticky top-0 bg-white">
              <tr>
                <th class="py-2 pr-2 w-16" data-i18n="th_week">Week</th>
                <th class="py-2 pr-2 w-28" data-i18n="th_date">Datum (vr)</th>
                <th class="py-2 pr-2" data-i18n="th_contract">Contract</th>
                <th class="py-2 pr-2" data-i18n="th_quote">Notering</th>
                <th class="py-2" data-i18n="th_sent">Stemming</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <p id="mismatchHint" class="hidden mt-2 text-xs text-amber-700 bg-amber-50 border border-amber-200 rounded-lg p-2">Opgelet: sommige rijen hebben een afwijkende week t.o.v. de datum. Controleer uw brondata.</p>
      </div>
    </aside>
  </main>

  <script>
  const APP_SCRIPT_JSON_URL = "https://script.google.com/macros/s/AKfycbyjwrJvwDFCu7_nIt9SvKajtbO2R9NuRPvaNXXzVhhQt3lnZH5VlxBTT_QqxqNyPsI7Wg/exec?mode=json";

  // ---------- I18N ----------
  let LANG = (new URLSearchParams(location.search).get('lang')) || 'nl';
  const T = {
    nl: {
      title:"Belgapom – Notering",
      subtitle:"Contractprijzen en wekelijkse notering (vrije aardappelen)",
      kpi_quote:"Notering", kpi_week:"Week", kpi_date:"Datum", kpi_sentiment:"Marktstemming",
      last_update_label:"Laatste update", source:"Bron: interne rapportering",
      table_title:"Overzicht per week", th_week:"Week", th_date:"Datum (vr)", th_contract:"Contract", th_quote:"Notering", th_sent:"Stemming",
      legend_title:"Legende marktstemming",
      legend_items:[
        "Flauw — aanbod is groter dan de vraag",
        "Rustig — aanbod is groter dan of gelijk aan de vraag",
        "Stabiel — aanbod is gelijk aan de vraag (evenwicht)",
        "Prijshoudend — aanbod is kleiner dan of gelijk aan de vraag",
        "Vast — aanbod is kleiner dan de vraag"
      ],
      rules_title:"Reglementering & toelichting",
      rules_body:[
        "Vrije markt en contracten in de Belgische diepvriesfrietsector:",
        "De wekelijkse Belgapomnotering voor vroege aardappelen (juli–augustus) en voor Fontane & Challenger (bewaarseizoen) geeft een duidelijke indicatie van de evolutie van de vrije aardappelmarkt voor de verwerking van aardappelen tot diepvriesfriet.",
        "Daarnaast maken telers, handel en verwerking in steeds grotere mate gebruik van teeltcontracten, die een grotere stabiliteit van de grondstofprijs beogen. De verhouding tussen beide instrumenten kan verschillen van bedrijf tot bedrijf. Beide componenten dienen in rekening gebracht te worden om de evolutie van de grondstofprijs te volgen.",
        "Daarom toont de grafiek bij de Belgapomnotering ook de evolutie van de contractprijzen naast de wekelijkse notering."
      ],
      loading_chart:"Data laden…", loading_table:"Tabel laden…", loading_error:"Kon data niet laden: "
    },
    fr: {
      title:"Belgapom – Cotation",
      subtitle:"Prix contractuels et cotation hebdomadaire (pommes de terre libres)",
      kpi_quote:"Cotation", kpi_week:"Semaine", kpi_date:"Date", kpi_sentiment:"Tendance du marché",
      last_update_label:"Dernière mise à jour", source:"Source : reporting interne",
      table_title:"Aperçu par semaine", th_week:"Semaine", th_date:"Date (ven)", th_contract:"Contrat", th_quote:"Cotation", th_sent:"Ambiance",
      legend_title:"Légende – tendance du marché",
      legend_items:[
        "Faible — l'offre est supérieure à la demande",
        "Calme — l'offre est supérieure ou égale à la demande",
        "Stable — l'offre est égale à la demande (équilibre)",
        "Soutenu — l'offre est inférieure ou égale à la demande",
        "Ferme — l'offre est inférieure à la demande"
      ],
      rules_title:"Réglementation & explications",
      rules_body:[
        "Marché libre et contrats dans le secteur belge des frites surgelées :",
        "La cotation hebdomadaire de Belgapom pour les pommes de terre précoces (juillet–août) et pour Fontane & Challenger (saison de conservation) indique clairement l’évolution du marché libre des pommes de terre destinées à la transformation en frites surgelées.",
        "Parallèlement, producteurs, commerce et industrie recourent de plus en plus aux contrats de culture visant une plus grande stabilité du prix de la matière première. La part relative de ces instruments peut varier d’une entreprise à l’autre. Les deux composantes doivent être prises en compte pour suivre l’évolution du prix.",
        "C’est pourquoi le graphique de la cotation Belgapom affiche également l’évolution des prix contractuels en plus de la cotation hebdomadaire."
      ],
      loading_chart:"Chargement des données…", loading_table:"Chargement du tableau…", loading_error:"Impossible de charger les données : "
    },
    en: {
      title:"Belgapom – Quotation",
      subtitle:"Contract prices and weekly quotation (free potatoes)",
      kpi_quote:"Quotation", kpi_week:"Week", kpi_date:"Date", kpi_sentiment:"Market sentiment",
      last_update_label:"Last update", source:"Source: internal reporting",
      table_title:"Overview per week", th_week:"Week", th_date:"Date (Fri)", th_contract:"Contract", th_quote:"Quotation", th_sent:"Sentiment",
      legend_title:"Legend – market sentiment",
      legend_items:[
        "Weak — supply exceeds demand",
        "Calm — supply is greater than or equal to demand",
        "Stable — supply equals demand (equilibrium)",
        "Supported — supply is less than or equal to demand",
        "Firm — supply is less than demand"
      ],
      rules_title:"Regulation & explanation",
      rules_body:[
        "Free market and contracts in the Belgian frozen-fries sector:",
        "The weekly Belgapom quotation for early potatoes (July–August) and for Fontane & Challenger (storage season) provides a clear indication of developments in the free potato market for processing into frozen fries.",
        "In addition, growers, traders and processors increasingly use production contracts to ensure greater stability in raw-material prices. The relative share of these instruments may vary from company to company. Both components should be taken into account to follow price evolution.",
        "Therefore, alongside the weekly quotation, the graph also shows the evolution of contract prices."
      ],
      loading_chart:"Loading data…", loading_table:"Loading table…", loading_error:"Could not load data: "
    }
  };

  function applyI18N(){
    const d=T[LANG];
    document.getElementById('title').textContent=d.title;
    document.getElementById('subtitle').textContent=d.subtitle;
    document.querySelectorAll('[data-i18n]').forEach(el=>{ const k=el.getAttribute('data-i18n'); if(d[k]) el.textContent=d[k]; });
    // Legend
    const ul=document.getElementById('legend_list'); ul.innerHTML='';
    d.legend_items.forEach(txt=>{ const li=document.createElement('li'); li.innerHTML = txt.replace(/^([^—-]+)/,'<strong>$1</strong>'); ul.appendChild(li); });
    // Rules
    const rb=document.getElementById('rules_body'); rb.innerHTML = d.rules_body.map(p=>`<p class="mb-2">${p}</p>`).join('');
    // Loaders
    document.getElementById('chartLoaderText').textContent = d.loading_chart;
    document.getElementById('tableLoaderText').textContent = d.loading_table;
    // html lang
    document.documentElement.lang = (LANG==='fr')?'fr':(LANG==='en'?'en':'nl');
  }

  // ---------- helpers ----------
  const euro = v => (v==null||v==='') ? '–' : new Intl.NumberFormat(LANG==='fr'?'fr-BE':LANG==='en'?'en-GB':'nl-BE', {style:'currency',currency:'EUR',maximumFractionDigits:0}).format(Number(v));
  const toNum = v => { if (v==null||v==='') return null; if (typeof v==='number') return isFinite(v)&&v>0 ? v : null; const s=String(v).replace(/[€\s]/g,'').replace(',','.'); const n=Number(s); return isFinite(n)&&n>0 ? n : null; };
  const prefersReduced = () => window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

  function formatDateISO(iso){ if(!iso) return '–'; const d=new Date(iso+'T00:00:00'); const loc=LANG==='fr'?'fr-BE':LANG==='en'?'en-GB':'nl-BE'; return d.toLocaleDateString(loc,{day:'2-digit',month:'2-digit',year:'numeric'}); }

  // ---------- state ----------
  let chart, allRows=[], seasonRows=[], seasonStartYear, latestRow; // contract key is always contract_price from backend

  // ---------- loaders ----------
  const showLoaders=()=>{ document.getElementById('chartLoader').classList.remove('loading-hidden'); document.getElementById('tableLoader').classList.remove('loading-hidden'); };
  const hideLoaders=()=>{ document.getElementById('chartLoader').classList.add('loading-hidden'); document.getElementById('tableLoader').classList.add('loading-hidden'); };

  // ---------- renderers ----------
  function sentimentPill(el, text){
    const s=(text||'').toLowerCase();
    el.textContent=text||'–';
    el.className='inline-block mt-1 px-3 py-1 rounded-full text-white text-xs ' + (
      s.includes('vast')||s.includes('ferme')||s.includes('firm') ? 'bg-green-600' :
      s.includes('houd')||s.includes('soutenu')||s.includes('support') ? 'bg-yellow-600' :
      s.includes('stabiel')||s.includes('stable') ? 'bg-slate-600' :
      s.includes('rustig')||s.includes('calme')||s.includes('calm') ? 'bg-slate-500' :
      s.includes('flauw')||s.includes('faible')||s.includes('weak')||s.includes('neg') ? 'bg-red-600' : 'bg-slate-600'
    );
  }

  function renderKPI(){
    document.getElementById('kpi-quote').textContent = euro(toNum(latestRow.notering));
    document.getElementById('kpi-week').textContent  = String(latestRow.week_num).padStart(2,'0');
    document.getElementById('kpi-date').textContent  = formatDateISO(latestRow.friday_date);
    sentimentPill(document.getElementById('kpi-sentiment'), latestRow.marktstemming);
    document.getElementById('lastUpdate').textContent = new Date().toLocaleString(LANG==='fr'?'fr-BE':LANG==='en'?'en-GB':'nl-BE',{timeZone:'Europe/Brussels'});
    document.getElementById('year').textContent = new Date().getFullYear();
  }

  function renderChart(){
    const order=[...Array(17)].map((_,i)=>36+i).concat([...Array(36)].map((_,i)=>i+1));
    const labels=order.map(n=>String(n).padStart(2,'0'));

    const byWeekC={}, byWeekQ={};
    seasonRows.forEach(r=>{ const w=r.week_num; const c=toNum(r.contract_price); if(c!=null) byWeekC[w]=c; const q=toNum(r.notering); if(q!=null) byWeekQ[w]=q; });
    const contract=order.map(w=>byWeekC[w]??null);
    const quote=order.map(w=>byWeekQ[w]??null);

    const vals=[...contract,...quote].filter(v=>Number.isFinite(v)&&v>0);
    let yMin=0,yMax=100,step=10;
    if(vals.length){
      const lo=Math.min(...vals), hi=Math.max(...vals), span=hi-lo, pad=Math.max(10,Math.round(span*0.1));
      const niceStep=sp=>{ const t=Math.max(1,sp/6), p=10**Math.floor(Math.log10(t)), b=t/p; return (b<=1?1:b<=2?2:b<=5?5:10)*p; };
      step=niceStep(span); yMin=Math.max(0,Math.floor((lo-pad)/step)*step); yMax=Math.ceil((hi+pad)/step)*step; if(yMax<=yMin) yMax=yMin+step;
    }

    const ctx=document.getElementById('chart').getContext('2d');
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
      type:'line',
      data:{
        labels,
        datasets:[
          { label: LANG==='fr'?"Prix contractuel (€/tonne)":LANG==='en'?"Contract price (€/tonne)":"Contractprijs (€/ton)",
            data: contract, borderWidth:3, pointRadius: (window.matchMedia && window.matchMedia('(pointer:coarse)').matches)?4:3,
            borderColor:'#1d2d44', backgroundColor:'transparent', stepped:true, spanGaps:false },
          { label: LANG==='fr'?"Cotation (€/tonne)":LANG==='en'?"Quotation (€/tonne)":"Notering (€/ton)",
            data: quote, borderWidth:3, pointRadius: (window.matchMedia && window.matchMedia('(pointer:coarse)').matches)?4:3,
            borderColor:'#748cab', backgroundColor:'transparent', spanGaps:false }
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        animation: prefersReduced()?false: { duration: 400 },
        interaction:{mode:'index', intersect:false},
        elements:{ line:{ tension:0 } },
        scales:{
          x:{ type:'category', ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit:24 }},
          y:{ min:yMin, max:yMax, ticks:{ stepSize:step, callback:v=>`${v} €` } }
        },
        plugins:{ legend:{ position:'bottom' } }
      }
    });
  }

  function renderTable(){
    const tbody=document.getElementById('tbody'); tbody.innerHTML='';
    const order=[...Array(17)].map((_,i)=>36+i).concat([...Array(36)].map((_,i)=>i+1));
    const byWeekC={}, byWeekQ={}, byWeekS={}, byWeekFri={}, byWeekMismatch={};
    seasonRows.forEach(r=>{
      const w=r.week_num;
      if (r.friday_date) byWeekFri[w]=r.friday_date;
      const c=toNum(r.contract_price); if(c!=null) byWeekC[w]=c;
      const q=toNum(r.notering); if(q!=null) byWeekQ[w]=q;
      if (r.marktstemming) byWeekS[w]=r.marktstemming;
      if (r.week_mismatch) byWeekMismatch[w]=true;
    });

    let anyMismatch=false;
    order.forEach(w=>{
      const mismatch = !!byWeekMismatch[w]; if(mismatch) anyMismatch=true;
      const tr=document.createElement('tr'); tr.className="border-b border-slate-100" + (mismatch?" bg-amber-50/50":"");
      tr.innerHTML=`<td class="py-1.5 pr-2">W${String(w).padStart(2,'0')}</td>
        <td class="py-1.5 pr-2">${formatDateISO(byWeekFri[w])}</td>
        <td class="py-1.5 pr-2">${euro(byWeekC[w])}</td>
        <td class="py-1.5 pr-2">${euro(byWeekQ[w])}</td>
        <td class="py-1.5">${byWeekS[w] ? `<span class="px-2 py-0.5 rounded-full text-xs text-white ${ (byWeekS[w].toLowerCase().includes('vast')||byWeekS[w].toLowerCase().includes('ferme')||byWeekS[w].toLowerCase().includes('firm'))? 'bg-green-600' : (byWeekS[w].toLowerCase().includes('houd')||byWeekS[w].toLowerCase().includes('soutenu')||byWeekS[w].toLowerCase().includes('support'))? 'bg-yellow-600' : (byWeekS[w].toLowerCase().includes('stabiel')||byWeekS[w].toLowerCase().includes('stable'))? 'bg-slate-600' : (byWeekS[w].toLowerCase().includes('rustig')||byWeekS[w].toLowerCase().includes('calme')||byWeekS[w].toLowerCase().includes('calm'))? 'bg-slate-500' : (byWeekS[w].toLowerCase().includes('flauw')||byWeekS[w].toLowerCase().includes('faible')||byWeekS[w].toLowerCase().includes('weak')||byWeekS[w].toLowerCase().includes('neg'))? 'bg-red-600' : 'bg-slate-600' }">${byWeekS[w]}</span>` : '–'}</td>`;
      tbody.appendChild(tr);
    });
    document.getElementById('tableSeason').textContent=`W36 ${seasonStartYear} – W36 ${seasonStartYear+1}`;
    document.getElementById('mismatchHint').classList.toggle('hidden', !anyMismatch);
  }

  // ---------- data flow ----------
  async function fetchJSON(u){
    const r=await fetch(u,{cache:'no-store'}); const t=await r.text();
    if(!t) throw new Error('Lege respons'); if(t.trim().startsWith('<')) throw new Error('HTML i.p.v. JSON');
    return JSON.parse(t);
  }

  function setActiveLangButton(){
    document.querySelectorAll('[data-lang]').forEach(btn=>{
      const active = btn.getAttribute('data-lang')===LANG;
      btn.setAttribute('aria-pressed', active? 'true':'false');
      btn.classList.toggle('bg-[#0d1321]', active);
      btn.classList.toggle('text-white', active);
      btn.classList.toggle('bg-white', !active);
    });
  }

  (async function init(){
    applyI18N(); setActiveLangButton();
    document.getElementById('btn-print').onclick=()=>window.print();
    document.getElementById('btn-nl').onclick=()=>{LANG='nl'; applyI18N(); setActiveLangButton(); renderKPI(); renderChart(); renderTable();};
    document.getElementById('btn-fr').onclick=()=>{LANG='fr'; applyI18N(); setActiveLangButton(); renderKPI(); renderChart(); renderTable();};
    document.getElementById('btn-en').onclick=()=>{LANG='en'; applyI18N(); setActiveLangButton(); renderKPI(); renderChart(); renderTable();};

    // Shadow hint on table overflow (mobile)
    const wrap=document.getElementById('tableWrap');
    const onScroll=()=>{ wrap.classList.toggle('scrolled', wrap.scrollLeft>8 || wrap.scrollWidth<=wrap.clientWidth); };
    wrap.addEventListener('scroll', onScroll, {passive:true});
    const ro=new ResizeObserver(onScroll); ro.observe(wrap);

    showLoaders();

    const data=await fetchJSON(APP_SCRIPT_JSON_URL);
    const rows = Array.isArray(data.rows) ? data.rows : [];
    if(!rows.length) throw new Error('Geen rijen in feed');
    allRows = rows;

    // Seizoensbepaling
    const last = allRows[allRows.length-1];
    const suggested = data.meta && data.meta.suggested_season_start_year;
    seasonStartYear = suggested ?? (last.week_num>=36 ? last.week_year : last.week_year-1);

    // Seizoensfilter W36 (Y) t/m W36 (Y+1) op basis van friday_date
    function isoWeekStart(y,w){ const simple=new Date(y,0,1+(w-1)*7); let dow=simple.getDay(); if(dow===0) dow=7; const mon=new Date(simple); mon.setDate(simple.getDate()-dow+1); return new Date(mon.getFullYear(), mon.getMonth(), mon.getDate()); }
    const start = isoWeekStart(seasonStartYear,36);
    const endMon = isoWeekStart(seasonStartYear+1,36); const end = new Date(endMon); end.setDate(endMon.getDate()+6);
    seasonRows = allRows.filter(r=>{ const d=new Date((r.friday_date||r.date)+'T00:00:00'); return d>=start && d<=end; });

    // Cutoff = laatste vrijdag in BE-tijd (van backend indien aanwezig)
    const cutoffIso = (data.meta && data.meta.latest_cutoff_friday_iso) ? data.meta.latest_cutoff_friday_iso : (()=>{
      const nowBE=new Date(new Date().toLocaleString('en-US',{timeZone:'Europe/Brussels'}));
      const dow=nowBE.getDay(); const dsf=(dow>=5)?(dow-5):(dow+2); const lf=new Date(nowBE); lf.setDate(nowBE.getDate()-dsf);
      return lf.toISOString().slice(0,10);
    })();

    // Laatste rij kiezen op basis van friday_date ≤ cutoff
    latestRow = seasonRows[seasonRows.length-1];
    for (let i=seasonRows.length-1;i>=0;i--){ const f = seasonRows[i].friday_date || seasonRows[i].date; if (f <= cutoffIso) { latestRow = seasonRows[i]; break; } }

    document.getElementById('seasonLabel').textContent=`W36 ${seasonStartYear} – W36 ${seasonStartYear+1}`;

    renderKPI();
    renderChart();
    renderTable();

    hideLoaders();
  })().catch(err=>{
    const d=T[LANG]||T.nl;
    document.getElementById('chartLoaderText').textContent = (d.loading_error||'Kon data niet laden: ')+err.message;
    document.getElementById('tableLoaderText').textContent  = (d.loading_error||'Kon data niet laden: ')+err.message;
  });
  </script>
</body>
</html>
