<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Belgapom – Notering / Cotation / Quotation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    @media print { .no-print { display:none !important } }
  </style>
</head>
<body class="bg-[#f0ebd8] text-[#0d1321]">
  <!-- Header -->
  <header class="sticky top-0 z-10 bg-white/85 backdrop-blur border-b border-black/10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div>
        <h1 id="title" class="font-semibold text-lg">Belgapom – Notering</h1>
        <p id="subtitle" class="text-sm text-slate-600">Contractprijzen en wekelijkse notering (vrije aardappelen)</p>
      </div>
      <div class="flex gap-2 no-print">
        <button id="btn-nl" class="px-3 py-1.5 rounded-lg border border-black/20 bg-white">NL</button>
        <button id="btn-fr" class="px-3 py-1.5 rounded-lg border border-black/20">FR</button>
        <button id="btn-en" class="px-3 py-1.5 rounded-lg border border-black/20">EN</button>
        <button id="btn-print" class="px-3 py-1.5 rounded-lg border border-black/20">PDF</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6 grid md:grid-cols-3 gap-6">
    <!-- Left -->
    <section class="md:col-span-2 space-y-4">
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold">Historiek</h2>
          <div id="seasonLabel" class="text-sm text-slate-600"></div>
        </div>

        <!-- KPIs (zonder contractprijs) -->
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4 text-sm">
          <div>
            <div class="text-slate-500" data-i18n="kpi_quote">Notering</div>
            <div id="kpi-quote" class="text-xl font-semibold">–</div>
          </div>
          <div>
            <div class="text-slate-500" data-i18n="kpi_week">Week</div>
            <div id="kpi-week" class="text-xl font-semibold">–</div>
          </div>
          <div>
            <div class="text-slate-500" data-i18n="kpi_date">Datum</div>
            <div id="kpi-date" class="text-xl font-semibold">–</div>
          </div>
          <div class="col-span-2 md:col-span-3">
            <div class="text-slate-500" data-i18n="kpi_sentiment">Marktstemming</div>
            <span id="kpi-sentiment" class="inline-block mt-1 px-3 py-1 rounded-full text-white bg-slate-600 text-xs">–</span>
          </div>
        </div>

        <!-- Chart -->
        <div class="relative h-[420px]">
          <canvas id="chart" aria-label="Grafiek contractprijs & notering" role="img"></canvas>
        </div>

        <!-- Legende marktstemming -->
        <div class="mt-4 p-4 rounded-xl border border-black/10 bg-slate-50 text-sm">
          <h3 class="font-semibold mb-2" data-i18n="legend_title">Legende marktstemming</h3>
          <ul class="list-disc pl-5 space-y-1" id="legend_list"></ul>
        </div>

        <!-- Reglementering -->
        <div class="mt-4 p-4 rounded-xl border border-black/10 bg-slate-50 text-sm leading-relaxed">
          <h3 class="font-semibold mb-2" data-i18n="rules_title">Reglementering & toelichting</h3>
          <div id="rules_body"></div>
        </div>
      </div>
    </section>

    <!-- Right -->
    <aside class="space-y-4">
      <div class="bg-white rounded-2xl shadow p-4 text-sm text-slate-700">
        <p class="mb-2"><span data-i18n="last_update_label">Laatste update</span>: <span id="lastUpdate">–</span></p>
        <p class="mb-2" data-i18n="source">Bron: interne rapportering</p>
        <p class="text-xs">© <span id="year"></span> Belgapom</p>
      </div>

      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between gap-2">
          <strong data-i18n="table_title">Overzicht per week</strong>
          <div class="text-sm text-slate-600" id="tableSeason"></div>
        </div>
        <div class="max-h-[360px] overflow-auto mt-3">
          <table class="w-full text-sm">
            <thead class="text-left text-slate-600 sticky top-0 bg-white">
              <tr>
                <th data-i18n="th_week">Week</th>
                <th data-i18n="th_date">Datum (vr)</th>
                <th data-i18n="th_contract">Contract</th>
                <th data-i18n="th_quote">Notering</th>
                <th data-i18n="th_sent">Stemming</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </aside>
  </main>

  <script>
  const APP_SCRIPT_JSON_URL = "https://script.google.com/macros/s/AKfycbwW3CJVv92gfK6P05uLP69FRkvVrZRNz7l06fTtyH_1P7gvJiWdmVTyE1ySLiTL465zvw/exec?mode=json";

  // ---------- I18N ----------
  let LANG = (new URLSearchParams(location.search).get('lang')) || 'nl';
  const T = {
    nl: {
      title:"Belgapom – Notering",
      subtitle:"Contractprijzen en wekelijkse notering (vrije aardappelen)",
      kpi_quote:"Notering", kpi_week:"Week", kpi_date:"Datum", kpi_sentiment:"Marktstemming",
      last_update_label:"Laatste update", source:"Bron: interne rapportering",
      table_title:"Overzicht per week", th_week:"Week", th_date:"Datum (vr)", th_contract:"Contract", th_quote:"Notering", th_sent:"Stemming",
      legend_title:"Legende marktstemming",
      legend_items:[
        "Flauw — aanbod is groter dan de vraag",
        "Rustig — aanbod is groter dan of gelijk aan de vraag",
        "Stabiel — aanbod is gelijk aan de vraag (evenwicht)",
        "Prijshoudend — aanbod is kleiner dan of gelijk aan de vraag",
        "Vast — aanbod is kleiner dan de vraag"
      ],
      rules_title:"Reglementering & toelichting",
      rules_body:[
        "Vrije markt en contracten in de Belgische diepvriesfrietsector:",
        "De wekelijkse Belgapomnotering voor vroege aardappelen (juli–augustus) en voor Fontane & Challenger (bewaarseizoen) geeft een duidelijke indicatie van de evolutie van de vrije aardappelmarkt voor de verwerking van aardappelen tot diepvriesfriet.",
        "Daarnaast maken telers, handel en verwerking in steeds grotere mate gebruik van teeltcontracten, die een grotere stabiliteit van de grondstofprijs beogen. De verhouding tussen beide instrumenten kan verschillen van bedrijf tot bedrijf. Beide componenten dienen in rekening gebracht te worden om de evolutie van de grondstofprijs te volgen.",
        "Daarom toont de grafiek bij de Belgapomnotering ook de evolutie van de contractprijzen naast de wekelijkse notering."
      ]
    },
    fr: {
      title:"Belgapom – Cotation",
      subtitle:"Prix contractuels et cotation hebdomadaire (pommes de terre libres)",
      kpi_quote:"Cotation", kpi_week:"Semaine", kpi_date:"Date", kpi_sentiment:"Tendance du marché",
      last_update_label:"Dernière mise à jour", source:"Source : reporting interne",
      table_title:"Aperçu par semaine", th_week:"Semaine", th_date:"Date (ven)", th_contract:"Contrat", th_quote:"Cotation", th_sent:"Ambiance",
      legend_title:"Légende – tendance du marché",
      legend_items:[
        "Faible — l'offre est supérieure à la demande",
        "Calme — l'offre est supérieure ou égale à la demande",
        "Stable — l'offre est égale à la demande (équilibre)",
        "Soutenu — l'offre est inférieure ou égale à la demande",
        "Ferme — l'offre est inférieure à la demande"
      ],
      rules_title:"Réglementation & explications",
      rules_body:[
        "Marché libre et contrats dans le secteur belge des frites surgelées :",
        "La cotation hebdomadaire de Belgapom pour les pommes de terre précoces (juillet–août) et pour Fontane & Challenger (saison de conservation) indique clairement l’évolution du marché libre des pommes de terre destinées à la transformation en frites surgelées.",
        "Parallèlement, producteurs, commerce et industrie recourent de plus en plus aux contrats de culture visant une plus grande stabilité du prix de la matière première. La part relative de ces instruments peut varier d’une entreprise à l’autre. Les deux composantes doivent être prises en compte pour suivre l’évolution du prix.",
        "C’est pourquoi le graphique de la cotation Belgapom affiche également l’évolution des prix contractuels en plus de la cotation hebdomadaire."
      ]
    },
    en: {
      title:"Belgapom – Quotation",
      subtitle:"Contract prices and weekly quotation (free potatoes)",
      kpi_quote:"Quotation", kpi_week:"Week", kpi_date:"Date", kpi_sentiment:"Market sentiment",
      last_update_label:"Last update", source:"Source: internal reporting",
      table_title:"Overview per week", th_week:"Week", th_date:"Date (Fri)", th_contract:"Contract", th_quote:"Quotation", th_sent:"Sentiment",
      legend_title:"Legend – market sentiment",
      legend_items:[
        "Weak — supply exceeds demand",
        "Calm — supply is greater than or equal to demand",
        "Stable — supply equals demand (equilibrium)",
        "Supported — supply is less than or equal to demand",
        "Firm — supply is less than demand"
      ],
      rules_title:"Regulation & explanation",
      rules_body:[
        "Free market and contracts in the Belgian frozen‑fries sector:",
        "The weekly Belgapom quotation for early potatoes (July–August) and for Fontane & Challenger (storage season) provides a clear indication of developments in the free potato market for processing into frozen fries.",
        "In addition, growers, traders and processors increasingly use production contracts to ensure greater stability in raw‑material prices. The relative share of these instruments may vary from company to company. Both components should be taken into account to follow price evolution.",
        "Therefore, alongside the weekly quotation, the graph also shows the evolution of contract prices."
      ]
    }
  };

  function applyI18N(){
    const d=T[LANG];
    document.getElementById('title').textContent=d.title;
    document.getElementById('subtitle').textContent=d.subtitle;
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const k=el.getAttribute('data-i18n'); if(d[k]) el.textContent=d[k];
    });
    // Legende
    const ul=document.getElementById('legend_list'); ul.innerHTML='';
    d.legend_items.forEach(txt=>{
      const li=document.createElement('li');
      li.innerHTML = txt.replace(/^([^—-]+)/,'<strong>$1</strong>');
      ul.appendChild(li);
    });
    // Reglementering
    const rb=document.getElementById('rules_body');
    rb.innerHTML = d.rules_body.map(p=>`<p class="mb-2">${p}</p>`).join('');
  }

  // ---------- helpers ----------
  const euro = v => (v==null||v==='') ? '–' : new Intl.NumberFormat(LANG==='fr'?'fr-BE':LANG==='en'?'en-GB':'nl-BE', {style:'currency',currency:'EUR',maximumFractionDigits:0}).format(Number(v));
  const toNum = v => {
    if (v==null||v==='') return null;
    if (typeof v==='number') return isFinite(v)&&v>0 ? v : null;
    const s=String(v).replace(/[€\s]/g,'').replace(',','.');
    const n=Number(s); return isFinite(n)&&n>0 ? n : null;
  };
  // ISO-week Monday start
  function isoWeekStart(year, week){
    const simple=new Date(year,0,1+(week-1)*7);
    let dow=simple.getDay(); if(dow===0) dow=7;
    const monday=new Date(simple); monday.setDate(simple.getDate()-dow+1);
    return new Date(monday.getFullYear(), monday.getMonth(), monday.getDate());
  }
  // ISO-week Friday date (Monday + 4)
  function isoWeekFriday(year, week){
    const mon = isoWeekStart(year, week);
    const fri = new Date(mon); fri.setDate(mon.getDate()+4);
    return fri;
  }
  function formatDateObj(d){
    const loc=LANG==='fr'?'fr-BE':LANG==='en'?'en-GB':'nl-BE';
    return d.toLocaleDateString(loc,{day:'2-digit',month:'2-digit',year:'numeric'});
  }
  // laatste vrijdag in Europe/Brussels
  function lastFridayISO(){
    const nowBE=new Date(new Date().toLocaleString('en-US',{timeZone:'Europe/Brussels'}));
    const dow=nowBE.getDay(); // 0=Sun..6=Sat, Fri=5
    const daysSinceFriday = (dow>=5) ? (dow-5) : (dow+2);
    const lastFri=new Date(nowBE); lastFri.setDate(nowBE.getDate()-daysSinceFriday);
    return lastFri.toISOString().slice(0,10);
  }

  // ---------- state ----------
  let chart, allRows=[], seasonRows=[], seasonStartYear, latestRow, contractKey='contract_price';

  // ---------- renderers ----------
  function renderKPI(){
    // toon steeds de VRIJDAG van die ISO-week
    const fri = isoWeekFriday(latestRow.week_year, latestRow.week_num);
    document.getElementById('kpi-quote').textContent = euro(toNum(latestRow.notering));
    document.getElementById('kpi-week').textContent = String(latestRow.week_num).padStart(2,'0');
    document.getElementById('kpi-date').textContent = formatDateObj(fri);
    const b=document.getElementById('kpi-sentiment'); b.textContent=latestRow.marktstemming||'–';
    const s=(latestRow.marktstemming||'').toLowerCase();
    b.className='inline-block mt-1 px-3 py-1 rounded-full text-white text-xs ' + (
      s.includes('vast')||s.includes('ferme')||s.includes('firm') ? 'bg-green-600' :
      s.includes('houd')||s.includes('soutenu')||s.includes('support') ? 'bg-yellow-600' :
      s.includes('stabiel')||s.includes('stable') ? 'bg-slate-600' :
      s.includes('rustig')||s.includes('calme')||s.includes('calm') ? 'bg-slate-500' :
      s.includes('flauw')||s.includes('faible')||s.includes('weak')||s.includes('neg') ? 'bg-red-600' : 'bg-slate-600'
    );
    document.getElementById('lastUpdate').textContent =
      new Date().toLocaleString(LANG==='fr'?'fr-BE':LANG==='en'?'en-GB':'nl-BE',{timeZone:'Europe/Brussels'});
    document.getElementById('year').textContent = new Date().getFullYear();
  }

  function renderChart(){
    // labels W36..W52, W01..W36 (numbers only)
    const order=[...Array(17)].map((_,i)=>36+i).concat([...Array(36)].map((_,i)=>i+1));
    const labels=order.map(n=>String(n).padStart(2,'0'));

    // build values
    const byWeekC={}, byWeekQ={};
    seasonRows.forEach(r=>{
      const w=r.week_num;
      const c=toNum(r[contractKey]); if(c!=null) byWeekC[w]=c;
      const q=toNum(r.notering); if(q!=null) byWeekQ[w]=q;
    });
    const contract=order.map(w=>byWeekC[w]??null);
    const quote=order.map(w=>byWeekQ[w]??null);

    const vals=[...contract,...quote].filter(v=>Number.isFinite(v)&&v>0);
    let yMin=0,yMax=100,step=10;
    if(vals.length){
      const lo=Math.min(...vals), hi=Math.max(...vals), span=hi-lo, pad=Math.max(10,Math.round(span*0.1));
      const niceStep=sp=>{ const t=Math.max(1,sp/6), p=10**Math.floor(Math.log10(t)), b=t/p; return (b<=1?1:b<=2?2:b<=5?5:10)*p; };
      step=niceStep(span); yMin=Math.max(0,Math.floor((lo-pad)/step)*step); yMax=Math.ceil((hi+pad)/step)*step; if(yMax<=yMin) yMax=yMin+step;
    }

    const ctx=document.getElementById('chart').getContext('2d');
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
      type:'line',
      data:{
        labels,
        datasets:[
          { label: LANG==='fr'?'Prix contractuel (€/tonne)':LANG==='en'?'Contract price (€/tonne)':'Contractprijs (€/ton)',
            data: contract, borderWidth:3, pointRadius:3, borderColor:'#1d2d44', backgroundColor:'transparent', stepped:true, spanGaps:false },
          { label: LANG==='fr'?'Cotation (€/tonne)':LANG==='en'?'Quotation (€/tonne)':'Notering (€/ton)',
            data: quote, borderWidth:3, pointRadius:3, borderColor:'#748cab', backgroundColor:'transparent', spanGaps:false }
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false, interaction:{mode:'index', intersect:false},
        scales:{
          x:{ type:'category', ticks:{ maxRotation:0, autoSkip:true, maxTicksLimit:24 }},
          y:{ min:yMin, max:yMax, ticks:{ stepSize:step, callback:v=>`${v} €` } }
        },
        plugins:{ legend:{ position:'bottom' } }
      }
    });
  }

  function renderTable(){
    const tbody=document.getElementById('tbody'); tbody.innerHTML='';
    const order=[...Array(17)].map((_,i)=>36+i).concat([...Array(36)].map((_,i)=>i+1));
    const byWeekC={}, byWeekQ={}, byWeekS={};
    seasonRows.forEach(r=>{ const w=r.week_num; const c=toNum(r.contract_price); if(c!=null) byWeekC[w]=c; const q=toNum(r.notering); if(q!=null) byWeekQ[w]=q; if(r.marktstemming) byWeekS[w]=r.marktstemming; });

    order.forEach(w=>{
      const year=(w>=36)?seasonStartYear:(seasonStartYear+1);
      const fri=isoWeekFriday(year,w); // vrijdag per week
      const tr=document.createElement('tr'); tr.className="border-b border-slate-100";
      tr.innerHTML=`<td class="py-1.5 pr-2">W${String(w).padStart(2,'0')}</td>
        <td class="py-1.5 pr-2">${formatDateObj(fri)}</td>
        <td class="py-1.5 pr-2">${euro(byWeekC[w])}</td>
        <td class="py-1.5 pr-2">${euro(byWeekQ[w])}</td>
        <td class="py-1.5">${byWeekS[w] || '–'}</td>`;
      tbody.appendChild(tr);
    });

    document.getElementById('tableSeason').textContent=`W36 ${seasonStartYear} – W36 ${seasonStartYear+1}`;
  }

  // ---------- data flow ----------
  async function fetchJSON(u){
    const r=await fetch(u,{cache:'no-store'}); const t=await r.text();
    if(!t) throw new Error('Lege respons'); if(t.trim().startsWith('<')) throw new Error('HTML i.p.v. JSON');
    return JSON.parse(t);
  }

  (async function init(){
    applyI18N();
    document.getElementById('btn-print').onclick=()=>window.print();
    document.getElementById('btn-nl').onclick=()=>{LANG='nl'; applyI18N(); renderKPI(); renderChart(); renderTable();};
    document.getElementById('btn-fr').onclick=()=>{LANG='fr'; applyI18N(); renderKPI(); renderChart(); renderTable();};
    document.getElementById('btn-en').onclick=()=>{LANG='en'; applyI18N(); renderKPI(); renderChart(); renderTable();};

    const data=await fetchJSON(APP_SCRIPT_JSON_URL);
    allRows = Array.isArray(data.rows) ? data.rows : [];
    if(!allRows.length) throw new Error('Geen rijen in feed');

    // kolomdetectie
    contractKey = ['contract_price','contractprijs','contract'].find(k=>k in allRows[0]) || 'contract_price';

    // Seizoensbepaling
    const last = allRows[allRows.length-1];
    const suggested = data.meta && data.meta.suggested_season_start_year;
    seasonStartYear = suggested ?? (last.week_num>=36 ? last.week_year : last.week_year-1);

    // Filter W36 (Y) .. W36 (Y+1)
    const seasonStart=isoWeekStart(seasonStartYear,36);
    const seasonEnd=new Date(isoWeekStart(seasonStartYear+1,36)); seasonEnd.setDate(seasonEnd.getDate()+6);
    seasonRows = allRows.filter(r=>{ const d=new Date(r.date+'T00:00:00'); return d>=seasonStart && d<=seasonEnd; });

    // Laatste vrijdag (Europe/Brussels) ≤ vandaag bepaalt “actueel”
    const cutoffIso = lastFridayISO();
    latestRow = seasonRows[seasonRows.length-1];
    for (let i=seasonRows.length-1;i>=0;i--){
      if (seasonRows[i].date <= cutoffIso) { latestRow = seasonRows[i]; break; }
    }

    document.getElementById('seasonLabel').textContent=`W36 ${seasonStartYear} – W36 ${seasonStartYear+1}`;

    renderKPI();
    renderChart();
    renderTable();
  })().catch(err=>{
    const ctx=document.getElementById('chart').getContext('2d');
    ctx.font='14px system-ui'; ctx.fillStyle='#b00020';
    ctx.fillText((LANG==='fr'?'Impossible de charger les données: ':LANG==='en'?'Could not load data: ':'Kon data niet laden: ')+err.message,10,22);
  });
  </script>
</body>
</html>
